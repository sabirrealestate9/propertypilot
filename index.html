<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EstateFlow Pro - Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%236EE7B7' d='M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8h5z'/%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-primary-100: 220 20% 12%; /* Dark Slate */
            --color-primary-200: 220 18% 18%; /* Darker Gray */
            --color-primary-300: 220 15% 25%; /* Medium Dark Gray */
            --color-primary-400: 220 12% 35%; /* Gray */
            --color-accent-teal: 160 80% 60%; /* Vibrant Teal */
            --color-accent-gold: 40 85% 60%; /* Soft Gold */
            --color-accent-sapphire: 220 70% 60%; /* Muted Sapphire */
            --color-accent-emerald: 120 70% 50%; /* Emerald Green */
            --color-accent-red: 0 70% 60%; /* Alert Red */
        }

        body {
            font-family: 'Inter', sans-serif;
            color: hsl(var(--color-primary-400));
            background-color: hsl(var(--color-primary-100));
            line-height: 1.6;
            overflow-x: hidden;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Outfit', sans-serif;
            color: hsl(220 10% 90%);
        }
        .header-gradient {
            background: linear-gradient(90deg, hsl(var(--color-primary-200)) 0%, hsl(var(--color-primary-100)) 100%);
        }
        .card-glass {
            background-color: hsla(var(--color-primary-200), 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid hsla(var(--color-primary-300), 0.3);
            box-shadow: 0 4px 30px hsla(0, 0%, 0%, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-glass:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 40px hsla(0, 0%, 0%, 0.3);
        }

        .text-accent-teal { color: hsl(var(--color-accent-teal)); }
        .bg-accent-teal { background-color: hsl(var(--color-accent-teal)); }
        .border-accent-teal { border-color: hsl(var(--color-accent-teal)); }
        .text-accent-gold { color: hsl(var(--color-accent-gold)); }
        .bg-accent-gold { background-color: hsl(var(--color-accent-gold)); }
        .text-accent-sapphire { color: hsl(var(--color-accent-sapphire)); }
        .bg-accent-sapphire { background-color: hsl(var(--color-accent-sapphire)); }
        .text-accent-emerald { color: hsl(var(--color-accent-emerald)); }
        .bg-accent-emerald { background-color: hsl(var(--color-accent-emerald)); }
        .text-accent-red { color: hsl(var(--color-accent-red)); }
        .bg-accent-red { background-color: hsl(var(--color-accent-red)); }

        .profit-positive { color: hsl(var(--color-accent-emerald)); }
        .profit-negative { color: hsl(var(--color-accent-red)); }

        .status-badge {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            white-space: nowrap;
        }

        .badge-ready { background: rgba(34,197,94,.15); color: rgba(34,197,94,1); border: 1px solid rgba(34,197,94,.25); }
        .badge-notready { background: rgba(239,68,68,.15); color: rgba(239,68,68,1); border: 1px solid rgba(239,68,68,.25); }
        .badge-neutral { background: rgba(99,102,241,.15); color: rgba(99,102,241,1); border: 1px solid rgba(99,102,241,.25); }

        .btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.55rem 1.1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, hsl(var(--color-accent-teal)), hsl(var(--color-accent-sapphire)));
            box-shadow: 0 12px 30px rgba(45, 212, 191, 0.18);
            transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 40px rgba(99, 102, 241, 0.22);
        }
        .btn-outline {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.55rem 1.1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            color: hsl(220 10% 90%);
            border: 1px solid hsla(var(--color-primary-300), 0.6);
            background: hsla(var(--color-primary-200), 0.35);
            transition: background .18s ease, transform .18s ease;
        }
        .btn-outline:hover {
            background: hsla(var(--color-primary-200), 0.6);
            transform: translateY(-1px);
        }

        /* Responsive grid adjustments */
        @media (min-width: 1024px) {
            .main-grid {
                grid-template-columns: repeat(6, 1fr);
                grid-template-rows: auto;
            }
            .kpi-card:nth-child(1) { grid-column: span 2; }
            .kpi-card:nth-child(2) { grid-column: span 2; }
            .kpi-card:nth-child(3) { grid-column: span 2; }
            .kpi-card:nth-child(4) { grid-column: span 3; }
            .kpi-card:nth-child(5) { grid-column: span 3; }
            .kpi-card:nth-child(6) { grid-column: span 6; }
        }

        .table-wrap::-webkit-scrollbar { height: 10px; }
        .table-wrap::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.12); border-radius: 9999px; }
        .table-wrap::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .muted { color: hsl(220 10% 70%); }

        .skeleton {
            position: relative;
            overflow: hidden;
        }
        .skeleton::after {
            content: "";
            position: absolute;
            inset: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
            animation: shimmer 1.1s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        .error-box {
            border: 1px solid rgba(239,68,68,.35);
            background: rgba(239,68,68,.12);
            color: rgba(254,202,202,1);
            border-radius: 1rem;
            padding: 0.9rem 1rem;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            100: 'hsl(var(--color-primary-100))',
                            200: 'hsl(var(--color-primary-200))',
                            300: 'hsl(var(--color-primary-300))',
                            400: 'hsl(var(--color-primary-400))',
                        },
                        accent: {
                            teal: 'hsl(var(--color-accent-teal))',
                            gold: 'hsl(var(--color-accent-gold))',
                            sapphire: 'hsl(var(--color-accent-sapphire))',
                            emerald: 'hsl(var(--color-accent-emerald))',
                            red: 'hsl(var(--color-accent-red))',
                        }
                    },
                    fontFamily: {
                        display: ['Outfit', 'sans-serif'],
                        body: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>

<body class="min-h-screen text-primary-400">

    <header class="header-gradient shadow-xl py-4 sticky top-0 z-50">
        <div class="container mx-auto px-6 flex flex-col md:flex-row items-center justify-between">
            <div class="flex items-center mb-4 md:mb-0">
                <svg class="h-8 w-8 text-accent-teal mr-3 transform rotate-45" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
                <h1 class="text-3xl font-display font-semibold text-white tracking-tight">EstateFlow <span class="text-accent-teal">Pro</span></h1>
            </div>

            <div class="flex items-center gap-3">
                <a id="openSheetBtn" class="btn-outline" href="#" target="_blank" rel="noopener">Open Sheet</a>
                <button id="refreshBtn" class="btn-primary" type="button">Refresh</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-12">

        <!-- Status / Error -->
        <div class="mb-8">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div>
                    <p class="muted text-sm">Data source: Google Sheets via Apps Script API</p>
                    <p id="lastUpdated" class="muted text-xs mt-1"></p>
                </div>

                <div class="flex flex-col md:flex-row items-stretch md:items-center gap-3 w-full md:w-auto">
                    <input id="searchInput" type="text"
                           class="w-full md:w-80 px-4 py-2 rounded-xl bg-white/5 border border-white/10 outline-none focus:border-accent-teal text-white placeholder:text-white/40"
                           placeholder="Search Studio / Owner / Tenant..." />
                    <select id="readyFilter"
                            class="w-full md:w-52 px-4 py-2 rounded-xl bg-white/5 border border-white/10 outline-none focus:border-accent-teal text-white">
                        <option value="">All Units</option>
                        <option value="ready">Move-in Ready</option>
                        <option value="notready">Not Ready</option>
                    </select>
                </div>
            </div>

            <div id="errorBox" class="mt-4 hidden error-box"></div>
        </div>

        <!-- KPI -->
        <section id="dashboard-overview" class="mb-16">
            <h2 class="text-4xl font-display font-bold text-white mb-10 text-center md:text-left">Portfolio Overview</h2>

            <div id="kpiGrid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-8 main-grid">
                <!-- Skeleton KPIs (replaced by JS) -->
                <div class="kpi-card card-glass p-8 rounded-2xl skeleton h-40"></div>
                <div class="kpi-card card-glass p-8 rounded-2xl skeleton h-40"></div>
                <div class="kpi-card card-glass p-8 rounded-2xl skeleton h-40"></div>
                <div class="kpi-card card-glass p-8 rounded-2xl skeleton h-40"></div>
                <div class="kpi-card card-glass p-8 rounded-2xl skeleton h-40"></div>
                <div class="kpi-card card-glass p-8 rounded-2xl skeleton h-40"></div>
            </div>
        </section>

        <!-- Monthly Profit (placeholder / can be wired later if you want) -->
        <section id="monthly-profit" class="mb-16">
            <h2 class="text-3xl font-display font-bold text-white mb-6">Monthly Profit Breakdown</h2>
            <div class="card-glass p-8 rounded-2xl">
                <p class="muted">
                    Coming soon: this section can be connected to your <strong>MonthlyProfits</strong> sheet to show month-wise charts.
                </p>
            </div>
        </section>

        <!-- Property Portfolio -->
        <section id="property-portfolio" class="mb-16">
            <h2 class="text-4xl font-display font-bold text-white mb-10 text-center md:text-left">Property Portfolio</h2>
            <div id="propertiesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Skeleton cards (replaced by JS) -->
                <div class="card-glass p-6 rounded-2xl skeleton h-72"></div>
                <div class="card-glass p-6 rounded-2xl skeleton h-72"></div>
                <div class="card-glass p-6 rounded-2xl skeleton h-72"></div>
            </div>
        </section>

        <!-- Contract Summary (placeholder) -->
        <section id="contract-summary" class="mb-16">
            <h2 class="text-3xl font-display font-bold text-white mb-6">Contract Overview</h2>
            <div class="card-glass p-8 rounded-2xl">
                <p class="muted">
                    Coming soon: this section can be wired to <strong>pending_actions</strong> / contracts sheet.
                </p>
            </div>
        </section>

        <!-- Recurring Expenses (placeholder) -->
        <section id="recurring-expenses" class="mb-16">
            <h2 class="text-3xl font-display font-bold text-white mb-6">Recurring Expenses</h2>
            <div class="card-glass p-8 rounded-2xl">
                <p class="muted">
                    Coming soon: this section can be wired to <strong>RecurringExpenses</strong> sheet (totals + list).
                </p>
            </div>
        </section>

        <!-- Rent Records (LIVE) -->
        <section id="rent-records" class="mb-16">
            <h2 class="text-3xl font-display font-bold text-white mb-6">Recent Rent Collection Records</h2>
            <div class="card-glass p-4 rounded-2xl overflow-x-auto table-wrap">
                <table class="w-full text-left table-auto">
                    <thead>
                        <tr class="text-sm text-primary-300 uppercase tracking-wider border-b border-primary-300/40">
                            <th class="py-3 px-4">ID</th>
                            <th class="py-3 px-4">Studio</th>
                            <th class="py-3 px-4">Payment Date</th>
                            <th class="py-3 px-4">Amount</th>
                            <th class="py-3 px-4">Ownership</th>
                            <th class="py-3 px-4">Month/Year</th>
                            <th class="py-3 px-4">Maintenance</th>
                            <th class="py-3 px-4">Profit</th>
                        </tr>
                    </thead>
                    <tbody id="rentTbody">
                        <tr>
                            <td class="py-4 px-4 muted" colspan="8">Loading…</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Account Balances (placeholder) -->
        <section id="account-balances">
            <h2 class="text-3xl font-display font-bold text-white mb-6">General Account Balances</h2>
            <div class="card-glass p-8 rounded-2xl">
                <p class="muted">
                    Coming soon: connect to <strong>PersonnelAccounts</strong> / <strong>CompanyAccounts</strong>.
                </p>
            </div>
        </section>

    </main>

    <script>
        // =========================
        // CONFIG
        // =========================
        const CONFIG = {
            API_URL: "https://script.google.com/macros/s/AKfycbwH7ICA4_BlTvfN5FU68YgSIDe6xA1ziuZx3Ajc1KXeMZY5P4inQ_IIyBMAev7C5oh_/exec",
            RECENT_RENT_ROWS: 25
        };

        // =========================
        // DOM
        // =========================
        const kpiGrid = document.getElementById("kpiGrid");
        const propertiesGrid = document.getElementById("propertiesGrid");
        const rentTbody = document.getElementById("rentTbody");
        const errorBox = document.getElementById("errorBox");
        const lastUpdated = document.getElementById("lastUpdated");
        const openSheetBtn = document.getElementById("openSheetBtn");
        const refreshBtn = document.getElementById("refreshBtn");
        const searchInput = document.getElementById("searchInput");
        const readyFilter = document.getElementById("readyFilter");

        // =========================
        // STATE
        // =========================
        let STATE = {
            properties: [],
            rentRecords: [],
            sheetUrl: "",
            lastUpdatedIso: ""
        };

        // =========================
        // HELPERS
        // =========================
        function setError(message) {
            if (!message) {
                errorBox.classList.add("hidden");
                errorBox.textContent = "";
                return;
            }
            errorBox.classList.remove("hidden");
            errorBox.textContent = message;
        }

        function safeText(v) {
            if (v === null || v === undefined) return "";
            return String(v).trim();
        }

        function toNumber(v) {
            if (v === null || v === undefined || v === "") return 0;
            if (typeof v === "number") return v;
            const s = String(v).replace(/AED/gi, "").replace(/,/g, "").trim();
            const n = Number(s);
            return Number.isFinite(n) ? n : 0;
        }

        function moneyAED(value) {
            const n = toNumber(value);
            return new Intl.NumberFormat("en-AE", { style: "currency", currency: "AED" }).format(n);
        }

        function toDateLabel(isoOrText) {
            const s = safeText(isoOrText);
            if (!s) return "—";
            const d = new Date(s);
            if (Number.isNaN(d.getTime())) return s;
            return d.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
        }

        function computeExpectedMonthly(properties) {
            const tenant = properties.reduce((sum, p) => sum + toNumber(p.TenantMonthlyRent ?? p.TenantRent ?? p.TenantRentMonthly), 0);
            const owner = properties.reduce((sum, p) => sum + toNumber(p.OwnerMonthlyRent ?? p.OwnerRent ?? p.OwnerRentMonthly), 0);
            return { tenant, owner, profit: tenant - owner };
        }

        function computeRentTotals(rentRecords) {
            const income = rentRecords.reduce((sum, r) => sum + toNumber(r.Amount), 0);
            const maint = rentRecords.reduce((sum, r) => sum + toNumber(r.Maintenance), 0);
            const profit = rentRecords.reduce((sum, r) => sum + toNumber(r.Profit), 0);
            return { income, maint, profit };
        }

        function profitClass(amount) {
            return toNumber(amount) >= 0 ? "profit-positive" : "profit-negative";
        }

        function readyStatus(p) {
            const v = (safeText(p.MoveInReady || p.ReadyToMove)).toLowerCase();
            const isReady = ["yes", "true", "1", "ready"].includes(v);
            return isReady ? "ready" : "notready";
        }

        // =========================
        // RENDER
        // =========================
        function renderKpis(properties, rentRecords) {
            const expected = computeExpectedMonthly(properties);
            const totals = computeRentTotals(rentRecords);

            const cards = [
                {
                    title: "Expected Tenant Rent (Monthly)",
                    value: moneyAED(expected.tenant),
                    icon: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z",
                    accent: "text-accent-gold"
                },
                {
                    title: "Expected Owner Rent (Monthly)",
                    value: moneyAED(expected.owner),
                    icon: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-1 15H9v-2h2v2zm0-4H9V7h2v6z",
                    accent: "text-accent-red"
                },
                {
                    title: "Expected Monthly Profit",
                    value: moneyAED(expected.profit),
                    icon: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-1.5 15h3a1.5 1.5 0 001.5-1.5V13c0-.83-.67-1.5-1.5-1.5h-3c-.83 0-1.5.67-1.5 1.5v2.5c0 .83.67 1.5 1.5 1.5zm0-8h3c.83 0 1.5.67 1.5 1.5V9c0-.83-.67-1.5-1.5-1.5h-3c-.83 0-1.5.67-1.5 1.5v2.5c0 .83.67 1.5 1.5 1.5z",
                    accent: expected.profit >= 0 ? "text-accent-emerald" : "text-accent-red"
                },
                {
                    title: "Rent Income (Records)",
                    value: moneyAED(totals.income),
                    icon: "M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6-2h-4v2h4V4z",
                    accent: "text-accent-sapphire"
                },
                {
                    title: "Maintenance (Records)",
                    value: moneyAED(totals.maint),
                    icon: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm-2-10h2c.55 0 1 .45 1 1v4c0 .55-.45 1-1 1h-2c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1z",
                    accent: "text-primary-300"
                },
                {
                    title: "Total Profit (Records)",
                    value: moneyAED(totals.profit),
                    icon: "M12 2c-5.52 0-10 4.48-10 10s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8zm-.5-13h-2v4h4v-2h-2V7z",
                    accent: totals.profit >= 0 ? "text-accent-emerald" : "text-accent-red"
                }
            ];

            kpiGrid.innerHTML = cards.map(c => `
                <div class="kpi-card card-glass p-8 rounded-2xl flex flex-col justify-between transform hover:scale-105 transition-all duration-300 ease-out">
                    <div>
                        <p class="text-white text-lg font-body mb-2 flex items-center">
                            <svg class="w-6 h-6 mr-2 ${c.accent}" fill="currentColor" viewBox="0 0 24 24">
                                <path d="${c.icon}"></path>
                            </svg>
                            ${c.title}
                        </p>
                        <h3 class="text-4xl md:text-5xl font-display font-bold ${c.accent}">${c.value}</h3>
                    </div>
                    <p class="text-sm mt-4 text-primary-300">Live from Google Sheets</p>
                </div>
            `).join("");
        }

        function renderProperties(properties) {
            const q = (searchInput.value || "").toLowerCase().trim();
            const rf = readyFilter.value;

            let items = [...properties];

            if (q) {
                items = items.filter(p => {
                    const hay = [
                        p.StudioId, p.Flat, p.Location, p.OwnerName, p.TenantName, p.OwnerContact, p.TenantContact
                    ].map(safeText).join(" ").toLowerCase();
                    return hay.includes(q);
                });
            }

            if (rf) {
                items = items.filter(p => readyStatus(p) === rf);
            }

            if (!items.length) {
                propertiesGrid.innerHTML = `
                    <div class="card-glass p-6 rounded-2xl md:col-span-2 lg:col-span-3">
                        <p class="muted">No properties match your filters.</p>
                    </div>
                `;
                return;
            }

            propertiesGrid.innerHTML = items.map(p => {
                const studio = safeText(p.StudioId || p.Flat || p.RecordId || "—");
                const owner = safeText(p.OwnerName || "—");
                const tenant = safeText(p.TenantName || "—");
                const loc = safeText(p.Location || "");
                const status = safeText(p.Status || "");
                const propertyType = safeText(p.Property || "");
                const daysLeft = (p.DaysLeft !== undefined && p.DaysLeft !== null) ? Number(p.DaysLeft) : null;

                const ownerRent = toNumber(p.OwnerMonthlyRent ?? p.OwnerRent);
                const tenantRent = toNumber(p.TenantMonthlyRent ?? p.TenantRent);
                const expectedProfit = tenantRent - ownerRent;

                const start = toDateLabel(p.ContractStartISO || p.TContractFrom);
                const end = toDateLabel(p.ContractEndISO || p.TContractTo);

                const ready = readyStatus(p);
                const badge = ready === "ready"
                    ? `<span class="status-badge badge-ready">● Ready</span>`
                    : `<span class="status-badge badge-notready">● Not Ready</span>`;

                const drive = safeText(p.DriveFolderLink || "");
                const driveDisabled = drive ? "" : "opacity-50 pointer-events-none";

                return `
                    <div class="property-card card-glass p-6 rounded-2xl flex flex-col hover:border-accent-teal cursor-pointer">
                        <h3 class="text-2xl font-display font-semibold text-white mb-3 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-accent-teal" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M10 20v-6h4v6h5v-8h3L12 3L2 12h3v8h5z"></path>
                            </svg>
                            Studio ID: ${studio}
                        </h3>

                        <div class="flex justify-between items-center mb-4 gap-3">
                            ${badge}
                            <span class="text-xl font-bold text-accent-gold">
                                ${moneyAED(expectedProfit)}
                                <span class="text-sm text-white">Expected Profit</span>
                            </span>
                        </div>

                        <div class="text-sm space-y-1 mb-4">
                            ${loc ? `<p class="text-primary-300">Location: <span class="text-white">${loc}</span></p>` : ""}
                            ${propertyType ? `<p class="text-primary-300">Property: <span class="text-white">${propertyType}</span></p>` : ""}
                            ${status ? `<p class="text-primary-300">Status: <span class="text-white">${status}</span></p>` : ""}
                            <p class="text-primary-300">Owner: <span class="text-white">${owner}</span></p>
                            <p class="text-primary-300">Tenant: <span class="text-white">${tenant}</span></p>
                            <p class="text-primary-300">Rents: <span class="text-white">Owner ${moneyAED(ownerRent)} | Tenant ${moneyAED(tenantRent)}</span></p>
                            <p class="text-primary-300">Contract: <span class="text-white">${start} to ${end}</span></p>
                            ${Number.isFinite(daysLeft) ? `<p class="text-primary-300">Days Left: <span class="text-accent-emerald">${daysLeft}</span></p>` : ""}
                        </div>

                        <a href="${drive || "#"}" target="_blank" rel="noopener" class="btn-primary mt-auto ${driveDisabled}">
                            View Drive Folder
                        </a>
                    </div>
                `;
            }).join("");
        }

        function renderRentRecords(rentRecords) {
            if (!rentRecords.length) {
                rentTbody.innerHTML = `<tr><td class="py-4 px-4 muted" colspan="8">No rent records found.</td></tr>`;
                return;
            }

            const sorted = [...rentRecords].sort((a, b) => {
                const da = safeText(a.PaymentDateISO || a.PaymentDate || "");
                const db = safeText(b.PaymentDateISO || b.PaymentDate || "");
                if (da !== db) return db.localeCompare(da);
                return toNumber(b.ID) - toNumber(a.ID);
            });

            const rows = sorted.slice(0, CONFIG.RECENT_RENT_ROWS);

            rentTbody.innerHTML = rows.map(r => {
                const profit = toNumber(r.Profit);
                return `
                    <tr class="border-b border-primary-300/30 hover:bg-primary-300/10 transition-colors duration-200">
                        <td class="py-4 px-4 text-white">${safeText(r.ID)}</td>
                        <td class="py-4 px-4 text-white">${safeText(r.StudioId || r.Flat || r.Unit)}</td>
                        <td class="py-4 px-4 text-white">${toDateLabel(r.PaymentDateISO || r.PaymentDate)}</td>
                        <td class="py-4 px-4 text-white">${moneyAED(r.Amount)}</td>
                        <td class="py-4 px-4 text-white">${safeText(r.Ownership)}</td>
                        <td class="py-4 px-4 text-white">${safeText(r.MonthYear)}</td>
                        <td class="py-4 px-4 text-white">${moneyAED(r.Maintenance)}</td>
                        <td class="py-4 px-4 ${profit >= 0 ? "profit-positive" : "profit-negative"}">${moneyAED(profit)}</td>
                    </tr>
                `;
            }).join("");
        }

        // =========================
        // LOAD
        // =========================
        async function loadData() {
            setError("");

            // Light skeletons
            kpiGrid.innerHTML = `
                <div class="kpi-card card-glass p-8 rounded-2xl skeleton h-40"></div>
                <div class="kpi-card card-glass p-8 rounded-2xl skeleton h-40"></div>
                <div class="kpi-card card-glass p-8 rounded-2xl skeleton h-40"></div>
                <div class="kpi-card card-glass p-8 rounded-2xl skeleton h-40"></div>
                <div class="kpi-card card-glass p-8 rounded-2xl skeleton h-40"></div>
                <div class="kpi-card card-glass p-8 rounded-2xl skeleton h-40"></div>
            `;
            propertiesGrid.innerHTML = `
                <div class="card-glass p-6 rounded-2xl skeleton h-72"></div>
                <div class="card-glass p-6 rounded-2xl skeleton h-72"></div>
                <div class="card-glass p-6 rounded-2xl skeleton h-72"></div>
            `;
            rentTbody.innerHTML = `<tr><td class="py-4 px-4 muted" colspan="8">Loading…</td></tr>`;

            try {
                const res = await fetch(CONFIG.API_URL, { method: "GET" });
                if (!res.ok) throw new Error(`API error: HTTP ${res.status}`);

                const payload = await res.json();
                if (!payload || !payload.ok) {
                    throw new Error(payload && payload.error ? payload.error : "Unknown API error");
                }

                STATE.properties = Array.isArray(payload.properties) ? payload.properties : [];
                STATE.rentRecords = Array.isArray(payload.rentRecords) ? payload.rentRecords : [];
                STATE.sheetUrl = safeText(payload.sheetUrl || "");
                STATE.lastUpdatedIso = safeText(payload.lastUpdatedIso || "");

                if (STATE.sheetUrl) openSheetBtn.href = STATE.sheetUrl;

                lastUpdated.textContent = STATE.lastUpdatedIso
                    ? `Last updated: ${new Date(STATE.lastUpdatedIso).toLocaleString("en-GB")}`
                    : "";

                renderKpis(STATE.properties, STATE.rentRecords);
                renderProperties(STATE.properties);
                renderRentRecords(STATE.rentRecords);

            } catch (err) {
                setError(err && err.message ? err.message : "Failed to load data.");
                kpiGrid.innerHTML = `
                    <div class="kpi-card card-glass p-8 rounded-2xl">
                        <p class="text-white">Unable to load KPIs.</p>
                        <p class="muted text-sm mt-2">Check your Apps Script deployment access and sheet names.</p>
                    </div>
                `;
                propertiesGrid.innerHTML = `
                    <div class="card-glass p-6 rounded-2xl md:col-span-2 lg:col-span-3">
                        <p class="text-white">Unable to load properties.</p>
                    </div>
                `;
                rentTbody.innerHTML = `<tr><td class="py-4 px-4 muted" colspan="8">Unable to load rent records.</td></tr>`;
            }
        }

        // =========================
        // EVENTS
        // =========================
        refreshBtn.addEventListener("click", loadData);
        searchInput.addEventListener("input", () => renderProperties(STATE.properties));
        readyFilter.addEventListener("change", () => renderProperties(STATE.properties));

        // Initial load
        loadData();
    </script>

</body>
</html>
