<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monthly Profit • Sabir Amin Real Estate Company LLC</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Shared UI Styles -->
  <link rel="stylesheet" href="app.css" />
</head>

<body data-page="monthly-profit">
  <div class="backdrop" id="backdrop"></div>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="logo">
      <div class="logo-icon"><i class="fas fa-gem"></i></div>
      <div class="logo-text">
        <div class="brand-name">Sabir Amin</div>
        <div class="brand-sub">Real Estate Company LLC</div>
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Main</div>
      <a href="index.html" class="nav-link"><i class="fas fa-th-large"></i>Dashboard</a>
      <a href="properties.html" class="nav-link"><i class="fas fa-building"></i>Properties</a>
      <a href="rent-records.html" class="nav-link">
        <i class="fas fa-file-invoice-dollar"></i>Rent Records
        <span class="nav-badge" id="rentBadge">0</span>
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Finance</div>
      <a href="transactions.html" class="nav-link"><i class="fas fa-exchange-alt"></i>Transactions</a>
      <a href="recurring-expenses.html" class="nav-link"><i class="fas fa-redo"></i>Recurring Expenses</a>
      <a href="monthly-profit.html" class="nav-link active"><i class="fas fa-chart-line"></i>Monthly Profit</a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Reports</div>
      <a href="reports.html" class="nav-link"><i class="fas fa-chart-bar"></i>Reports</a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">System</div>
      <a href="settings.html" class="nav-link"><i class="fas fa-cog"></i>Settings</a>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="topbar">
      <div class="page-title">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
          <button class="hamburger" id="menuBtn" title="Menu"><i class="fas fa-bars"></i></button>
          <h1>Monthly Profit</h1>
        </div>
        <p>
          Portfolio profit analysis by month, owner, and property.
          <span id="nowMeta" style="font-weight:900;"></span>
        </p>
      </div>

      <div class="header-actions">
        <div class="pill" title="Theme">
          <i class="fas fa-moon" style="color:var(--opal-lilac);"></i>
          <span>Theme: <strong id="themeLabel">Light</strong></span>
        </div>

        <select class="select" id="monthSelect" title="Select month">
          <option value="">Loading months…</option>
        </select>

        <button class="btn btn-secondary btn-icon" id="themeBtn" title="Toggle dark mode">
          <i class="fas fa-circle-half-stroke"></i>
        </button>

        <a class="btn btn-secondary" id="exportBtn" href="#" title="Export CSV (demo)">
          <i class="fas fa-file-export"></i> Export
        </a>
      </div>
    </header>

    <!-- Loading / Error -->
    <div id="ppLoading" class="overlay-loading" style="display:none;">
      <div class="overlay-card">
        <i class="fas fa-spinner fa-spin" style="color:var(--opal-cyan);"></i>
        <span>Loading live data…</span>
      </div>
    </div>

    <div id="ppError" class="inline-error" style="display:none;"></div>

    <!-- Hero KPIs -->
    <section class="card" aria-label="Monthly profit overview">
      <div class="card-header">
        <div>
          <div class="card-title"><i class="fas fa-sack-dollar"></i> Snapshot</div>
          <div class="card-sub">Selected month summary (calculated from your sheets)</div>
        </div>
        <span class="pill" title="Data source">
          <i class="fas fa-database" style="color:var(--opal-cyan);"></i>
          <span>Source: <strong id="dataSourceLabel">Google Sheet</strong></span>
        </span>
      </div>

      <div class="card-body">
        <div class="kpi-grid" style="margin:0;">
          <div class="kpi-card card" style="grid-column: span 3;">
            <div class="kpi-row">
              <div>
                <div class="kpi-label">Total Income</div>
                <div class="kpi-value" id="mpIncome">—</div>
                <div class="kpi-sub" id="mpIncomeSub">—</div>
              </div>
              <div class="kpi-icon"><i class="fas fa-arrow-trend-up"></i></div>
            </div>
            <div class="kpi-chip up"><i class="fas fa-circle-check"></i> Collected</div>
          </div>

          <div class="kpi-card card" style="grid-column: span 3;">
            <div class="kpi-row">
              <div>
                <div class="kpi-label">Total Expenses</div>
                <div class="kpi-value" id="mpExpenses">—</div>
                <div class="kpi-sub" id="mpExpensesSub">—</div>
              </div>
              <div class="kpi-icon"><i class="fas fa-arrow-trend-down"></i></div>
            </div>
            <div class="kpi-chip down"><i class="fas fa-receipt"></i> Costs</div>
          </div>

          <div class="kpi-card card" style="grid-column: span 3;">
            <div class="kpi-row">
              <div>
                <div class="kpi-label">Net Profit</div>
                <div class="kpi-value" id="mpNet">—</div>
                <div class="kpi-sub" id="mpNetSub">—</div>
              </div>
              <div class="kpi-icon"><i class="fas fa-chart-line"></i></div>
            </div>
            <div class="kpi-chip info"><i class="fas fa-wave-square"></i> Net</div>
          </div>

          <div class="kpi-card card" style="grid-column: span 3;">
            <div class="kpi-row">
              <div>
                <div class="kpi-label">Profit Margin</div>
                <div class="kpi-value" id="mpMargin">—</div>
                <div class="kpi-sub">Net / Income</div>
              </div>
              <div class="kpi-icon"><i class="fas fa-percent"></i></div>
            </div>
            <div class="kpi-chip warn"><i class="fas fa-gauge-high"></i> Margin</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Charts -->
    <section class="charts-grid" aria-label="Monthly profit charts" style="margin-top:16px;">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><i class="fas fa-chart-line"></i> Profit Trend</div>
            <div class="card-sub">Last 12 months (auto from your monthly aggregation)</div>
          </div>
          <button class="btn btn-secondary btn-icon" id="refreshChartsBtn" title="Refresh">
            <i class="fas fa-rotate"></i>
          </button>
        </div>
        <div class="card-body" style="height:260px;">
          <canvas id="trendChart"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title"><i class="fas fa-chart-pie"></i> Profit by Owner</div>
            <div class="card-sub">Selected month</div>
          </div>
        </div>
        <div class="card-body" style="height:260px;">
          <canvas id="ownerChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="card" aria-label="Profit breakdown" style="margin-top:16px;">
      <div class="card-header">
        <div>
          <div class="card-title"><i class="fas fa-table"></i> Profit Breakdown</div>
          <div class="card-sub">Per property (income, expenses, net, margin)</div>
        </div>

        <span class="pill" title="Visible rows">
          <i class="fas fa-eye" style="color:var(--opal-cyan);"></i>
          <span>Rows: <strong id="mpRows">0</strong></span>
        </span>
      </div>

      <div class="card-body" style="padding:0;">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Unit</th>
                <th>Owner</th>
                <th>Tenant</th>
                <th>Income</th>
                <th>Expenses</th>
                <th>Other</th>
                <th>Net</th>
                <th>Margin</th>
              </tr>
            </thead>
            <tbody id="monthlyProfitTbody">
              <tr>
                <td colspan="8" style="padding:18px 14px;color:var(--text-secondary);font-weight:900;">
                  Loading…
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Shared App Logic -->
  <script src="app.js"></script>

  <!-- Page Logic -->
  <script>
    /************************************************************
     * Monthly Profit Page
     * Requirements:
     * - Keep same UI
     * - Load data from Google Sheet (multiple sheets) via app.js data layer
     *
     * Expectations from app.js:
     * - window.PropertyPilot.initCommonUI() handles sidebar/theme/time
     * - window.PropertyPilot.getMonthlyProfitModel() returns:
     *     {
     *        months: [{ key:'2026-01', label:'Jan 2026' }, ...],
     *        currency: 'QAR',
     *        trend: [{ key:'2025-02', label:'Feb', net: 9500 }, ...],
     *        current: {
     *           key:'2026-01',
     *           totals: { income: 42500, expenses: 29600, other: 0, net: 12900, margin: 0.304 },
     *           byOwner: [{ owner:'Shumon', net: 8800 }, ...],
     *           rows: [{ unit, owner, tenant, income, expenses, other, net, margin }]
     *        }
     *     }
     * - window.PropertyPilot.setLoading(isLoading, errorText?)
     ************************************************************/

    let trendChart, ownerChart;

    function money(n, cur){
      const v = Number(n || 0);
      return v.toLocaleString(undefined, { maximumFractionDigits: 0 }) + " " + (cur || "");
    }
    function pct(n){
      const v = Number(n || 0) * 100;
      return v.toFixed(1) + "%";
    }

    function getGridColor(){
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      return isDark ? "rgba(255,255,255,0.08)" : "rgba(0,0,0,0.06)";
    }
    function getTickColor(){
      const isDark = document.documentElement.getAttribute("data-theme") === "dark";
      return isDark ? "rgba(230,233,239,0.80)" : "rgba(84,110,122,0.90)";
    }

    function destroyCharts(){
      if(trendChart){ trendChart.destroy(); trendChart = null; }
      if(ownerChart){ ownerChart.destroy(); ownerChart = null; }
    }

    function renderCharts(model){
      destroyCharts();

      // Trend
      const tctx = document.getElementById("trendChart").getContext("2d");
      trendChart = new Chart(tctx, {
        type: "line",
        data: {
          labels: (model.trend || []).map(x => x.label),
          datasets: [{
            label: "Net Profit",
            data: (model.trend || []).map(x => x.net),
            borderColor: "#4dd0e1",
            backgroundColor: "rgba(77, 208, 225, 0.12)",
            borderWidth: 3,
            fill: true,
            tension: 0.42,
            pointRadius: 3.8,
            pointHoverRadius: 6,
            pointBackgroundColor: "#4dd0e1"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: { label: (ctx) => ` ${ctx.parsed.y.toLocaleString()}` }
            }
          },
          scales: {
            y: { grid: { color: getGridColor() }, ticks: { color: getTickColor() } },
            x: { grid: { display: false }, ticks: { color: getTickColor() } }
          }
        }
      });

      // Owner
      const octx = document.getElementById("ownerChart").getContext("2d");
      const byOwner = model.current?.byOwner || [];
      ownerChart = new Chart(octx, {
        type: "doughnut",
        data: {
          labels: byOwner.map(x => x.owner),
          datasets: [{
            data: byOwner.map(x => x.net),
            // Keep same palette vibe (Chart.js will render as-is)
            backgroundColor: ["#4dd0e1","#9575cd","#69f0ae","#ef6c00","#c62828","#1a237e","#00bcd4"],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "bottom",
              labels: { color: getTickColor(), boxWidth: 14, font: { weight: "700" } }
            }
          },
          cutout: "68%"
        }
      });
    }

    function fillMonthSelect(months, currentKey){
      const sel = document.getElementById("monthSelect");
      sel.innerHTML = "";
      months.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.key;
        opt.textContent = m.label;
        if(m.key === currentKey) opt.selected = true;
        sel.appendChild(opt);
      });
    }

    function renderTable(rows, currency){
      const tb = document.getElementById("monthlyProfitTbody");
      tb.innerHTML = "";
      (rows || []).forEach(r => {
        const tr = document.createElement("tr");
        const netClass = (Number(r.net || 0) >= 0) ? "money pos" : "money neg";
        tr.innerHTML = `
          <td><strong>${escapeHtml(r.unit || "")}</strong></td>
          <td>${escapeHtml(r.owner || "—")}</td>
          <td>${escapeHtml(r.tenant || "—")}</td>
          <td>${money(r.income, currency)}</td>
          <td>${money(r.expenses, currency)}</td>
          <td>${money(r.other, currency)}</td>
          <td><span class="${netClass}">${money(r.net, currency)}</span></td>
          <td>${(r.margin == null) ? "—" : pct(r.margin)}</td>
        `;
        tb.appendChild(tr);
      });
      document.getElementById("mpRows").textContent = String((rows || []).length);
    }

    function renderKPIs(totals, currency){
      document.getElementById("mpIncome").textContent = money(totals.income, currency);
      document.getElementById("mpExpenses").textContent = money(totals.expenses, currency);
      document.getElementById("mpNet").textContent = money(totals.net, currency);
      document.getElementById("mpMargin").textContent = (totals.margin == null) ? "—" : pct(totals.margin);

      document.getElementById("mpIncomeSub").textContent = "Income";
      document.getElementById("mpExpensesSub").textContent = "Expenses";
      document.getElementById("mpNetSub").textContent = "Net";
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function loadAndRender(selectedKey){
      try{
        if(window.PropertyPilot?.setLoading) window.PropertyPilot.setLoading(true);

        const model = await window.PropertyPilot.getMonthlyProfitModel({ monthKey: selectedKey });

        fillMonthSelect(model.months || [], model.current?.key || "");
        renderKPIs(model.current?.totals || { income:0, expenses:0, net:0, margin:0 }, model.currency || "");
        renderTable(model.current?.rows || [], model.currency || "");
        renderCharts(model);

        if(window.PropertyPilot?.setLoading) window.PropertyPilot.setLoading(false);
      } catch (err){
        if(window.PropertyPilot?.setLoading) window.PropertyPilot.setLoading(false, (err && err.message) ? err.message : "Failed to load data.");
        console.error(err);
      }
    }

    // Init
    window.addEventListener("DOMContentLoaded", async () => {
      // Common UI (sidebar/theme/time/nav active) from app.js
      window.PropertyPilot?.initCommonUI?.();

      // initial load
      await loadAndRender("");

      // month change
      document.getElementById("monthSelect").addEventListener("change", async (e) => {
        await loadAndRender(e.target.value);
      });

      // refresh charts
      document.getElementById("refreshChartsBtn").addEventListener("click", async () => {
        const current = document.getElementById("monthSelect").value;
        await loadAndRender(current);
      });

      // export demo
      document.getElementById("exportBtn").addEventListener("click", (e) => {
        e.preventDefault();
        alert("Export: connect this to a CSV/PDF export in your Apps Script.");
      });
    });
  </script>

  <!-- Small helpers for select styling on this page (optional; move to app.css if you prefer) -->
  <style>
    .select{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-weight: 900;
      box-shadow: var(--shadow-sm);
      outline: none;
      min-width: 200px;
    }
    .select:focus{ box-shadow: 0 0 0 4px var(--focus); border-color: rgba(0,188,212,0.55); }

    .overlay-loading{
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: color-mix(in srgb, var(--bg-secondary) 85%, transparent);
      z-index: 9999;
    }
    .overlay-card{
      background: var(--bg-primary);
      padding: 16px 18px;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: Inter, sans-serif;
      color: var(--text-primary);
      font-weight: 900;
      border: 1px solid var(--border-soft);
    }
    .inline-error{
      margin: 12px 0;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(198,40,40,0.30);
      background: rgba(198,40,40,0.08);
      color: #b71c1c;
      font-family: Inter, sans-serif;
      font-size: 13px;
      font-weight: 800;
    }
  </style>
</body>
</html>
