<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Properties • Sabir Amin Real Estate Company LLC</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />

  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

  <!-- IMPORTANT: keep same design as app.css -->
  <link rel="stylesheet" href="app.css" />

  <style>
    /* Page-only helpers (kept minimal; core design remains in app.css) */
    .filters-bar { display:flex; gap:12px; margin: 10px 0 18px; flex-wrap: wrap; align-items:center; justify-content: space-between; }
    .filters-left, .filters-right { display:flex; gap: 12px; flex-wrap: wrap; align-items:center; }

    .table-wrap { overflow-x:auto; }
    table { width: 100%; border-collapse: collapse; min-width: 1200px; }
    th, td { text-align:left; }
    th { position: sticky; top: 0; z-index: 2; }

    .unit-pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 1000;
      background: var(--opal-gradient);
      border: 1px solid color-mix(in srgb, var(--border-soft) 65%, transparent);
      color: var(--navy);
      white-space: nowrap;
    }

    .status-badge{
      display:inline-flex;
      align-items:center;
      gap: 7px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 1000;
      border: 1px solid color-mix(in srgb, var(--border-soft) 65%, transparent);
      white-space: nowrap;
      line-height: 1;
    }
    .status-badge::before{ content:''; width:7px; height:7px; border-radius:50%; background: currentColor; }
    .status-badge.active{ background: rgba(46,125,50,0.10); color: var(--status-active); }
    .status-badge.expiring{ background: rgba(239,108,0,0.10); color: var(--status-expiring); }
    .status-badge.expired{ background: rgba(198,40,40,0.10); color: var(--status-expired); }
    .status-badge.vacant{ background: rgba(21,101,192,0.10); color: var(--status-info); }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      font-size: 11px;
      font-weight: 1000;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid color-mix(in srgb, var(--border) 70%, transparent);
      background: color-mix(in srgb, var(--bg-secondary) 55%, transparent);
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .action-btn{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-primary);
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      font-size: 12px;
      font-weight: 900;
      transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
      user-select:none;
      white-space: nowrap;
    }
    .action-btn:hover{ transform: translateY(-1px); }
    .action-btn.primary{
      background: var(--opal-accent);
      color: #fff;
      border: none;
    }
    .action-btn.danger{
      background: rgba(198,40,40,0.10);
      color: var(--status-expired);
      border-color: rgba(198,40,40,0.16);
    }

    /* Modal (Add/Edit) - uses same card look */
    .modal{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .modal.show{ display:flex; }
    .modal-backdrop{
      position:absolute;
      inset:0;
      background: rgba(12,18,38,0.45);
    }
    .modal-card{
      position: relative;
      width: min(980px, 100%);
      max-height: 90vh;
      overflow: auto;
      background: var(--bg-primary);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
    }
    .modal-header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-soft);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      background: linear-gradient(180deg, color-mix(in srgb, var(--bg-secondary) 55%, transparent), transparent);
    }
    .modal-title{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 1000;
      letter-spacing: -0.2px;
    }
    .modal-body{ padding: 14px 16px; }
    .modal-footer{
      padding: 14px 16px;
      border-top: 1px solid var(--border-soft);
      display:flex;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
      background: linear-gradient(0deg, color-mix(in srgb, var(--bg-secondary) 55%, transparent), transparent);
    }

    .form-grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .field{ grid-column: span 6; }
    .field.sm{ grid-column: span 3; }
    .field.lg{ grid-column: span 12; }

    .label{
      font-size: 12px;
      font-weight: 900;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 2px 0 6px;
    }
    .input, .select, .textarea{
      width: 100%;
      border: 1px solid var(--border);
      background: var(--bg-primary);
      color: var(--text-primary);
      padding: 10px 12px;
      border-radius: 12px;
      outline: none;
      font-weight: 700;
      font-size: 13px;
    }
    .textarea{ min-height: 90px; resize: vertical; }
    .input:focus, .select:focus, .textarea:focus{
      border-color: rgba(0,188,212,0.55);
      box-shadow: 0 0 0 4px var(--focus);
    }

    /* Responsive (match app.css behavior) */
    @media (max-width: 1100px){
      table{ min-width: 1100px; }
    }
    @media (max-width: 860px){
      .filters-bar{ align-items: stretch; }
      .filters-left, .filters-right{ justify-content: flex-start; }
      .field, .field.sm{ grid-column: span 12; }
    }
  </style>
</head>

<body>
  <!-- Loading + error (same pattern you used in other pages) -->
  <div id="ppLoading" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(245,247,250,0.85);z-index:9999;">
    <div style="background:white;padding:16px 18px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.12);display:flex;align-items:center;gap:10px;font-family:Inter, sans-serif;">
      <i class="fas fa-spinner fa-spin" style="color:#00bcd4;"></i>
      <span style="font-size:14px;color:#37474f;">Loading live data…</span>
    </div>
  </div>
  <div id="ppError" style="display:none;margin:12px 0;padding:12px 14px;border-radius:10px;border:1px solid rgba(244,67,54,0.35);background:rgba(244,67,54,0.08);color:#b71c1c;font-family:Inter, sans-serif;font-size:13px;"></div>

  <!-- Sidebar (kept same structure you already use) -->
  <nav class="sidebar" id="sidebar">
    <div class="logo">
      <div class="logo-icon"><i class="fas fa-gem"></i></div>
      <div class="logo-text">
        <div class="brand-name">Sabir Amin</div>
        <div class="brand-sub">Real Estate Company LLC</div>
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Main</div>
      <a href="index.html" class="nav-link"><i class="fas fa-th-large"></i>Dashboard</a>
      <a href="properties.html" class="nav-link active"><i class="fas fa-building"></i>Properties</a>
      <a href="rent-records.html" class="nav-link">
        <i class="fas fa-file-invoice-dollar"></i>Rent Records
        <span class="nav-badge" id="rentBadge">3</span>
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Finance</div>
      <a href="transactions.html" class="nav-link"><i class="fas fa-exchange-alt"></i>Transactions</a>
      <a href="recurring-expenses.html" class="nav-link"><i class="fas fa-redo"></i>Recurring Expenses</a>
      <a href="monthly-profit.html" class="nav-link"><i class="fas fa-chart-line"></i>Monthly Profit</a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Reports</div>
      <a href="reports.html" class="nav-link"><i class="fas fa-chart-bar"></i>Reports</a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">System</div>
      <a href="settings.html" class="nav-link"><i class="fas fa-cog"></i>Settings</a>
    </div>
  </nav>

  <!-- Main -->
  <main class="main-content">
    <!-- Header (uses same topbar/card classes from app.css) -->
    <header class="topbar">
      <div class="page-title">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
          <button class="hamburger" id="menuBtn" title="Menu"><i class="fas fa-bars"></i></button>
          <h1>Properties</h1>
        </div>
        <p>
          Manage your portfolio units, owners, tenants, contracts, and Drive folders.
          <span id="nowMeta" style="font-weight:900;"></span>
        </p>
      </div>

      <div class="header-actions">
        <div class="pill" title="Theme">
          <i class="fas fa-moon" style="color:var(--opal-lilac);"></i>
          <span>Theme: <strong id="themeLabel">Light</strong></span>
        </div>

        <div class="search-box" title="Search unit / owner / tenant / location">
          <i class="fas fa-search"></i>
          <input id="searchInput" type="text" placeholder="Search unit / owner / tenant / location…" />
        </div>

        <button class="btn btn-secondary btn-icon" id="themeBtn" title="Toggle dark mode">
          <i class="fas fa-circle-half-stroke"></i>
        </button>

        <a class="btn btn-secondary" id="exportBtn" href="#" title="Export (CSV)">
          <i class="fas fa-file-export"></i> Export
        </a>

        <button class="btn btn-primary" id="openAddBtn" title="Add new property">
          <i class="fas fa-plus"></i> Add Property
        </button>
      </div>
    </header>

    <!-- Summary Strip (kept; values auto-filled from sheet when available) -->
    <section class="kpi-grid" aria-label="Portfolio summary">
      <div class="kpi-card card">
        <div class="kpi-row">
          <div>
            <div class="kpi-label">Total Units</div>
            <div class="kpi-value" id="sumTotalUnits">—</div>
            <div class="kpi-sub">All properties</div>
          </div>
          <div class="kpi-icon"><i class="fas fa-building"></i></div>
        </div>
        <div class="kpi-chip info"><i class="fas fa-layer-group"></i> Portfolio count</div>
      </div>

      <div class="kpi-card card">
        <div class="kpi-row">
          <div>
            <div class="kpi-label">Occupied</div>
            <div class="kpi-value" id="sumOccupied">—</div>
            <div class="kpi-sub">Currently rented</div>
          </div>
          <div class="kpi-icon"><i class="fas fa-user-check"></i></div>
        </div>
        <div class="kpi-chip up"><i class="fas fa-arrow-up"></i> Live from sheet</div>
      </div>

      <div class="kpi-card card">
        <div class="kpi-row">
          <div>
            <div class="kpi-label">Vacant</div>
            <div class="kpi-value" id="sumVacant">—</div>
            <div class="kpi-sub">Available units</div>
          </div>
          <div class="kpi-icon"><i class="fas fa-door-open"></i></div>
        </div>
        <div class="kpi-chip warn"><i class="fas fa-bolt"></i> Action list</div>
      </div>

      <div class="kpi-card card">
        <div class="kpi-row">
          <div>
            <div class="kpi-label">Expiring (90d)</div>
            <div class="kpi-value" id="sumExpiring">—</div>
            <div class="kpi-sub">Contracts nearing end</div>
          </div>
          <div class="kpi-icon"><i class="fas fa-calendar-exclamation"></i></div>
        </div>
        <div class="kpi-chip down"><i class="fas fa-clock"></i> Renew soon</div>
      </div>
    </section>

    <!-- Filters -->
    <div class="filters-bar">
      <div class="filters-left">
        <select class="filter-select" id="typeFilter">
          <option value="">All Types</option>
          <option value="Studio">Studio</option>
          <option value="Apartment">Apartment</option>
          <option value="Villa">Villa</option>
          <option value="Commercial">Commercial</option>
        </select>

        <select class="filter-select" id="statusFilter">
          <option value="">All Status</option>
          <option value="Active">Active</option>
          <option value="Expiring">Expiring</option>
          <option value="Expired">Expired</option>
          <option value="Vacant">Vacant</option>
        </select>

        <select class="filter-select" id="ownerFilter">
          <option value="">All Owners</option>
        </select>
      </div>

      <div class="filters-right">
        <button class="btn btn-secondary" id="refreshBtn" title="Refresh data from Google Sheet">
          <i class="fas fa-rotate"></i> Refresh
        </button>
      </div>
    </div>

    <!-- Table -->
    <section class="card" aria-label="Properties list">
      <div class="card-header">
        <div>
          <div class="card-title"><i class="fas fa-table"></i> Properties</div>
          <div class="card-sub">Live list from Google Sheet (with search & filters)</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <span class="pill" title="Records loaded">
            <i class="fas fa-database" style="color:var(--opal-cyan);"></i>
            <span>Loaded: <strong id="loadedCount">0</strong></span>
          </span>
          <span class="pill" title="Filtered results">
            <i class="fas fa-filter" style="color:var(--opal-lilac);"></i>
            <span>Showing: <strong id="shownCount">0</strong></span>
          </span>
        </div>
      </div>

      <div class="card-body" style="padding:0;">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Unit</th>
                <th>Type</th>
                <th>Location</th>
                <th>Owner</th>
                <th>Tenant</th>
                <th>Days Left</th>
                <th>Rent In</th>
                <th>Rent Out</th>
                <th>Profit</th>
                <th>Status</th>
                <th>Drive</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="propertiesTbody">
              <!-- filled by app.js / PropertyPilot -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Add/Edit Property Modal (kept in this page; hooks ready; no deletion) -->
  <div class="modal" id="propertyModal" aria-hidden="true">
    <div class="modal-backdrop" id="modalBackdrop"></div>

    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <i class="fas fa-building" style="color:var(--opal-cyan);"></i>
          <span id="modalTitleText">Add / Edit Property</span>
        </div>
        <button class="btn btn-secondary btn-icon" id="closeModalBtn" title="Close">
          <i class="fas fa-xmark"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-grid">
          <div class="field sm">
            <div class="label">Unit / Studio ID</div>
            <input class="input" id="fUnit" placeholder="e.g., S_No 1 / z1 va2 r6" />
          </div>

          <div class="field sm">
            <div class="label">Type</div>
            <select class="select" id="fType">
              <option value="">Select…</option>
              <option>Studio</option>
              <option>Apartment</option>
              <option>Villa</option>
              <option>Commercial</option>
            </select>
          </div>

          <div class="field sm">
            <div class="label">Status</div>
            <select class="select" id="fStatus">
              <option value="">Select…</option>
              <option>Active</option>
              <option>Expiring</option>
              <option>Expired</option>
              <option>Vacant</option>
              <option>Draft</option>
            </select>
          </div>

          <div class="field sm">
            <div class="label">Days Left</div>
            <input class="input" id="fDaysLeft" type="number" placeholder="e.g., 90" />
          </div>

          <div class="field">
            <div class="label">Owner</div>
            <input class="input" id="fOwner" placeholder="Owner name" />
          </div>

          <div class="field">
            <div class="label">Tenant</div>
            <input class="input" id="fTenant" placeholder="Tenant name (or blank if vacant)" />
          </div>

          <div class="field">
            <div class="label">Location</div>
            <input class="input" id="fLocation" placeholder="Area / building / city" />
          </div>

          <div class="field">
            <div class="label">Drive Folder Link</div>
            <input class="input" id="fDrive" placeholder="https://drive.google.com/..." />
          </div>

          <div class="field sm">
            <div class="label">Rent In</div>
            <input class="input" id="fRentIn" type="number" placeholder="e.g., 2400" />
          </div>

          <div class="field sm">
            <div class="label">Rent Out</div>
            <input class="input" id="fRentOut" type="number" placeholder="e.g., 3100" />
          </div>

          <div class="field sm">
            <div class="label">Currency</div>
            <select class="select" id="fCurrency">
              <option>QAR</option>
              <option>AED</option>
              <option>USD</option>
            </select>
          </div>

          <div class="field lg">
            <div class="label">Notes</div>
            <textarea class="textarea" id="fNotes" placeholder="Any notes (contracts, contacts, maintenance, etc.)"></textarea>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div class="pill" style="display:inline-flex;" title="Integration note">
            <i class="fas fa-circle-info" style="color:var(--opal-cyan);"></i>
            <span>
              Saving can be connected to Google Sheet via your Apps Script endpoint in <strong>app-config.js</strong>.
            </span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" id="modalCancelBtn">
          <i class="fas fa-ban"></i> Cancel
        </button>
        <button class="btn btn-secondary" id="modalSaveDraftBtn" title="Save draft locally (demo)">
          <i class="fas fa-floppy-disk"></i> Save Draft
        </button>
        <button class="btn btn-primary" id="modalSaveBtn" title="Save to Google Sheet (requires endpoint)">
          <i class="fas fa-cloud-arrow-up"></i> Save to Sheet
        </button>
      </div>
    </div>
  </div>

  <!-- Quick Actions FAB (kept, not removed) -->
  <div class="quick-actions">
    <button class="fab" id="fabBtn" title="Quick Add">
      <i class="fas fa-plus"></i>
    </button>
  </div>

  <!-- Config + Data + Main app (do not remove) -->
  <script src="app-config.js"></script>
  <script src="app-data.js"></script>
  <script src="app.js"></script>

  <script>
    /************************************************************
     * KEEP SAME APP BEHAVIOR (theme, time, sidebar) - uses app.js
     * DO NOT DELETE ANYTHING: only add page glue here.
     ************************************************************/

    // Live time (same pattern as your dashboard)
    const nowMeta = document.getElementById("nowMeta");
    function tick(){
      const d = new Date();
      nowMeta.textContent = "• " + d.toLocaleString("en-GB", { weekday:"short", day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" });
    }
    tick();
    setInterval(tick, 30_000);

    // Page init through PropertyPilot (same convention you used)
    window.addEventListener("DOMContentLoaded", async () => {
      if (window.PropertyPilot && typeof window.PropertyPilot.initPage === "function") {
        await window.PropertyPilot.initPage("properties");
      }

      // Wire UI-only filters/search to PropertyPilot if implemented in app.js,
      // otherwise we do local filtering here using loaded table rows.
      const searchInput = document.getElementById("searchInput");
      const typeFilter = document.getElementById("typeFilter");
      const statusFilter = document.getElementById("statusFilter");
      const ownerFilter = document.getElementById("ownerFilter");
      const refreshBtn = document.getElementById("refreshBtn");

      const openAddBtn = document.getElementById("openAddBtn");
      const fabBtn = document.getElementById("fabBtn");

      const modal = document.getElementById("propertyModal");
      const modalBackdrop = document.getElementById("modalBackdrop");
      const closeModalBtn = document.getElementById("closeModalBtn");
      const modalCancelBtn = document.getElementById("modalCancelBtn");

      const exportBtn = document.getElementById("exportBtn");

      function showModal(){
        modal.classList.add("show");
        modal.setAttribute("aria-hidden","false");
      }
      function hideModal(){
        modal.classList.remove("show");
        modal.setAttribute("aria-hidden","true");
      }

      openAddBtn.addEventListener("click", showModal);
      fabBtn.addEventListener("click", showModal);
      modalBackdrop.addEventListener("click", hideModal);
      closeModalBtn.addEventListener("click", hideModal);
      modalCancelBtn.addEventListener("click", hideModal);

      // Local filter fallback (works even if app.js filtering is not present)
      function applyLocalFilters(){
        const q = (searchInput.value || "").trim().toLowerCase();
        const t = (typeFilter.value || "").trim().toLowerCase();
        const s = (statusFilter.value || "").trim().toLowerCase();
        const o = (ownerFilter.value || "").trim().toLowerCase();

        const tbody = document.getElementById("propertiesTbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        let shown = 0;
        rows.forEach(tr => {
          const txt = tr.innerText.toLowerCase();
          const rowType = (tr.getAttribute("data-type") || "").toLowerCase();
          const rowStatus = (tr.getAttribute("data-status") || "").toLowerCase();
          const rowOwner = (tr.getAttribute("data-owner") || "").toLowerCase();

          const okQ = !q || txt.includes(q);
          const okT = !t || rowType === t;
          const okS = !s || rowStatus === s;
          const okO = !o || rowOwner === o;

          const show = okQ && okT && okS && okO;
          tr.style.display = show ? "" : "none";
          if(show) shown++;
        });

        document.getElementById("shownCount").textContent = String(shown);
      }

      // Fill Owner dropdown from loaded rows (fallback)
      function rebuildOwnerFilter(){
        const tbody = document.getElementById("propertiesTbody");
        const owners = new Set();
        tbody.querySelectorAll("tr").forEach(tr => {
          const owner = (tr.getAttribute("data-owner") || "").trim();
          if(owner) owners.add(owner);
        });

        const prev = ownerFilter.value;
        ownerFilter.innerHTML = `<option value="">All Owners</option>` + Array.from(owners)
          .sort((a,b)=>a.localeCompare(b))
          .map(x => `<option value="${x.replaceAll('"','&quot;')}">${x}</option>`)
          .join("");

        // best-effort restore
        if(prev && Array.from(owners).includes(prev)) ownerFilter.value = prev;
      }

      // When PropertyPilot finishes rendering, it can call this hook:
      // window.__PP_ON_PROPERTIES_RENDER?.()
      window.__PP_ON_PROPERTIES_RENDER = () => {
        const tbody = document.getElementById("propertiesTbody");
        const total = tbody.querySelectorAll("tr").length;
        document.getElementById("loadedCount").textContent = String(total);

        rebuildOwnerFilter();
        applyLocalFilters();
      };

      searchInput.addEventListener("input", applyLocalFilters);
      typeFilter.addEventListener("change", applyLocalFilters);
      statusFilter.addEventListener("change", applyLocalFilters);
      ownerFilter.addEventListener("change", applyLocalFilters);

      refreshBtn.addEventListener("click", async () => {
        if(window.PropertyPilot && typeof window.PropertyPilot.initPage === "function"){
          await window.PropertyPilot.initPage("properties");
        }
        // In case app.js does not re-call the hook:
        setTimeout(() => window.__PP_ON_PROPERTIES_RENDER && window.__PP_ON_PROPERTIES_RENDER(), 250);
      });

      // Export CSV (client-side)
      exportBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const tbody = document.getElementById("propertiesTbody");
        const rows = Array.from(tbody.querySelectorAll("tr")).filter(r => r.style.display !== "none");
        const headers = ["Unit","Type","Location","Owner","Tenant","Days Left","Rent In","Rent Out","Profit","Status","Drive"];
        const lines = [headers.join(",")];

        rows.forEach(tr => {
          const cols = Array.from(tr.querySelectorAll("td")).slice(0, 11).map(td => {
            const val = (td.innerText || "").replaceAll("\n"," ").trim().replaceAll('"','""');
            return `"${val}"`;
          });
          lines.push(cols.join(","));
        });

        const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `properties_export_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });

      // Modal save buttons (demo/local + sheet)
      document.getElementById("modalSaveDraftBtn").addEventListener("click", () => {
        const draft = collectForm();
        const key = "pp_property_drafts";
        const arr = JSON.parse(localStorage.getItem(key) || "[]");
        arr.unshift({ ...draft, _savedAt: new Date().toISOString() });
        localStorage.setItem(key, JSON.stringify(arr));
        alert("Draft saved locally (demo). Connect Save to Sheet via Apps Script endpoint.");
        hideModal();
      });

      document.getElementById("modalSaveBtn").addEventListener("click", async () => {
        const payload = collectForm();
        try{
          if(window.PropertyPilot && typeof window.PropertyPilot.saveProperty === "function"){
            await window.PropertyPilot.saveProperty(payload);
            alert("Saved to Sheet (success).");
            hideModal();
            await window.PropertyPilot.initPage("properties");
          } else {
            alert("Save endpoint not wired yet. Implement PropertyPilot.saveProperty(payload) in app.js (Apps Script POST).");
          }
        } catch(err){
          alert("Save failed: " + (err?.message || err));
        }
      });

      function collectForm(){
        return {
          unit: document.getElementById("fUnit").value || "",
          type: document.getElementById("fType").value || "",
          status: document.getElementById("fStatus").value || "",
          daysLeft: document.getElementById("fDaysLeft").value || "",
          owner: document.getElementById("fOwner").value || "",
          tenant: document.getElementById("fTenant").value || "",
          location: document.getElementById("fLocation").value || "",
          drive: document.getElementById("fDrive").value || "",
          rentIn: document.getElementById("fRentIn").value || "",
          rentOut: document.getElementById("fRentOut").value || "",
          currency: document.getElementById("fCurrency").value || "QAR",
          notes: document.getElementById("fNotes").value || ""
        };
      }

      // If app.js didn’t call render hook, do it once after load
      setTimeout(() => window.__PP_ON_PROPERTIES_RENDER && window.__PP_ON_PROPERTIES_RENDER(), 350);
    });
  </script>
</body>
</html>
