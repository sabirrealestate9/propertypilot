<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sabir Real Estate - Rent Records</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111c33; --muted:#94a3b8; --text:#e2e8f0;
      --accent:#38bdf8; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --line:#223156; --btn:#1d4ed8; --btn2:#334155;
    }
    *{box-sizing:border-box;font-family:Segoe UI, Arial, sans-serif}
    body{margin:0;background:linear-gradient(180deg,#0b1222, #0f172a);color:var(--text)}
    header{padding:18px 22px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center}
    header h1{font-size:18px;margin:0;font-weight:700}
    header .sub{color:var(--muted);font-size:13px}
    main{padding:18px;display:grid;grid-template-columns: 360px 1fr; gap:16px; align-items:start}
    .card{background:rgba(17,28,51,.9);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);font-weight:700}
    .card .bd{padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{
      width:100%; padding:10px 10px; border-radius:10px; border:1px solid var(--line);
      background:#0b1327; color:var(--text); outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    .btnbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{
      cursor:pointer; border:1px solid var(--line); border-radius:10px; padding:10px 12px;
      background:var(--btn2); color:var(--text); font-weight:600;
    }
    button.primary{background:var(--btn);border-color:#1e40af}
    button.accent{background:#075985;border-color:#0ea5e9}
    button:disabled{opacity:.5;cursor:not-allowed}
    .hint{color:var(--muted);font-size:12px;margin-top:10px;line-height:1.4}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);
      padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .pill b{color:var(--text)}
    .status{margin-top:10px;font-size:12px;color:var(--muted);white-space:pre-wrap}
    .tablewrap{overflow:auto;border-radius:14px}
    table{width:100%;border-collapse:collapse;min-width:860px}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:13px}
    th{position:sticky;top:0;background:#0b1327;color:#cbd5e1;z-index:1}
    tr:hover td{background:rgba(56,189,248,.06)}
    .tag{font-size:12px;font-weight:700;padding:4px 8px;border-radius:999px;display:inline-block}
    .tag.good{background:rgba(34,197,94,.15);color:var(--good);border:1px solid rgba(34,197,94,.35)}
    .tag.bad{background:rgba(239,68,68,.15);color:var(--bad);border:1px solid rgba(239,68,68,.35)}
    .tag.warn{background:rgba(245,158,11,.15);color:var(--warn);border:1px solid rgba(245,158,11,.35)}
    .split{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .mini{font-size:12px;color:var(--muted)}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .kpi .box{border:1px solid var(--line);border-radius:12px;padding:10px;background:#0b1327}
    .kpi .box .n{font-weight:800;font-size:16px;color:var(--text)}
    .kpi .box .t{font-size:12px;color:var(--muted)}
    .files{margin-top:10px;border:1px dashed var(--line);border-radius:12px;padding:10px}
    .files ul{margin:0;padding-left:18px;color:var(--muted);font-size:12px}
    .rightNote{white-space:pre-wrap;font-size:12px;color:var(--muted);line-height:1.4}
  </style>
</head>
<body>
<header>
  <div>
    <h1>Rent Records Portal</h1>
    <div class="sub">Record rent, upload evidence (multi-files), verify Paid + Docs, and preview evidence on double click.</div>
  </div>
  <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
    <span class="pill">API: <b id="apiBaseTxt">http://localhost:5000</b></span>
    <button onclick="setApiBase()">Change API</button>
  </div>
</header>

<main>
  <!-- LEFT PANEL -->
  <section class="card">
    <div class="hd">Filters & Actions</div>
    <div class="bd">
      <div class="row">
        <div>
          <label>Month</label>
          <select id="monthSel"></select>
        </div>
        <div>
          <label>Year</label>
          <select id="yearSel"></select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Studio</label>
        <select id="studioSel"></select>
        <div class="hint">Studio list is loaded from your backend (same logic as your WinForms: paid/unpaid filtering).</div>
      </div>

      <div style="margin-top:10px">
        <label><input type="checkbox" id="onlyUnpaidChk" /> Show Only Unpaid Studios</label>
      </div>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0">

      <div class="row">
        <div>
          <label>Payment Date</label>
          <input type="date" id="payDate" />
        </div>
        <div>
          <label>Amount (AED)</label>
          <input type="number" id="amount" placeholder="e.g. 2900" />
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Maintenance (optional)</label>
        <input type="number" id="maintenance" placeholder="e.g. 0" />
      </div>

      <div class="files">
        <label>Evidence Files (Multiple)</label>
        <input type="file" id="evidenceFiles" multiple />
        <div class="mini">Selected files:</div>
        <ul id="fileList"><li>(none)</li></ul>
      </div>

      <div class="btnbar">
        <button class="primary" id="btnRecord" onclick="recordPayment()">Record Payment</button>
        <button class="accent" onclick="verifyPaidDocs()">Verify Paid + Docs</button>
        <button onclick="loadDashboard()">Refresh Dashboard</button>
      </div>

      <div class="status" id="statusBox"></div>
    </div>
  </section>

  <!-- RIGHT PANEL -->
  <section class="split">
    <section class="card">
      <div class="hd">Verification & Payment History</div>
      <div class="bd">
        <div class="hint">
          • Double click a row to open evidence preview (if docs exist).<br>
          • Uses the same Google Drive folder structure: Studio → Year → Month ("MM - MMMM").
        </div>

        <div class="tablewrap" style="margin-top:12px">
          <table id="grid">
            <thead>
              <tr>
                <th style="width:180px">Studio ID</th>
                <th style="width:90px">Paid?</th>
                <th style="width:120px">Evidence Files</th>
                <th>Verification Status</th>
              </tr>
            </thead>
            <tbody id="gridBody">
              <tr><td colspan="4" class="mini">No data yet. Click “Verify Paid + Docs”.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="hd">Month Summary</div>
      <div class="bd">
        <div class="kpi">
          <div class="box">
            <div class="n" id="kpiUnpaidCount">-</div>
            <div class="t">Unpaid Studios</div>
          </div>
          <div class="box">
            <div class="n" id="kpiUnpaidAmount">-</div>
            <div class="t">Total Unpaid Amount (AED)</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="mini">Unpaid Details</div>
          <div class="rightNote" id="unpaidDetails">(not loaded)</div>
        </div>
      </div>
    </section>
  </section>
</main>

<script>
  // -------------------- SETTINGS --------------------
  let API_BASE = localStorage.getItem("RE_API_BASE") || "http://localhost:5000";
  document.getElementById("apiBaseTxt").textContent = API_BASE;

  function setApiBase(){
    const v = prompt("Enter API base URL (example: http://localhost:5000)", API_BASE);
    if(!v) return;
    API_BASE = v.replace(/\/+$/,'');
    localStorage.setItem("RE_API_BASE", API_BASE);
    document.getElementById("apiBaseTxt").textContent = API_BASE;
    boot();
  }

  // -------------------- HELPERS --------------------
  function $(id){ return document.getElementById(id); }

  function setStatus(msg){
    $("statusBox").textContent = msg || "";
  }

  function ym(){
    const month = parseInt($("monthSel").value,10);
    const year  = parseInt($("yearSel").value,10);
    return {month, year};
  }

  async function api(path, options){
    const res = await fetch(API_BASE + path, options);
    const text = await res.text();
    let data = null;
    try{ data = text ? JSON.parse(text) : null; }catch{ data = text; }
    if(!res.ok){
      const msg = (data && data.message) ? data.message : (typeof data === "string" ? data : JSON.stringify(data));
      throw new Error(msg || ("HTTP " + res.status));
    }
    return data;
  }

  function formatAED(n){
    if(n === null || n === undefined || isNaN(n)) return "-";
    return new Intl.NumberFormat("en-US",{minimumFractionDigits:2, maximumFractionDigits:2}).format(n);
  }

  // -------------------- INIT --------------------
  function fillMonthYear(){
    const mSel = $("monthSel");
    const ySel = $("yearSel");

    mSel.innerHTML = "";
    for(let m=1;m<=12;m++){
      const opt = document.createElement("option");
      opt.value = String(m);
      opt.textContent = m; // you can change to month names if you want
      mSel.appendChild(opt);
    }

    const now = new Date();
    mSel.value = String(now.getMonth()+1);

    ySel.innerHTML = "";
    const y0 = now.getFullYear();
    for(let y=y0-2; y<=y0+2; y++){
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      ySel.appendChild(opt);
    }
    ySel.value = String(y0);

    // default date
    const d = new Date();
    $("payDate").value = d.toISOString().slice(0,10);
  }

  function wire(){
    $("onlyUnpaidChk").addEventListener("change", loadStudios);
    $("monthSel").addEventListener("change", async ()=>{ await loadStudios(); await loadDashboard(); });
    $("yearSel").addEventListener("change", async ()=>{ await loadStudios(); await loadDashboard(); });

    $("evidenceFiles").addEventListener("change", ()=>{
      const ul = $("fileList");
      ul.innerHTML = "";
      const files = $("evidenceFiles").files;
      if(!files || files.length===0){
        ul.innerHTML = "<li>(none)</li>";
        return;
      }
      for(const f of files){
        const li = document.createElement("li");
        li.textContent = f.name;
        ul.appendChild(li);
      }
    });
  }

  // -------------------- LOAD STUDIOS --------------------
  async function loadStudios(){
    try{
      setStatus("Loading studios...");
      const {month, year} = ym();
      const onlyUnpaid = $("onlyUnpaidChk").checked;

      // Endpoint: GET /api/studios?month=1&year=2026&onlyUnpaid=true
      const data = await api(`/api/studios?month=${month}&year=${year}&onlyUnpaid=${onlyUnpaid}`);

      const sSel = $("studioSel");
      sSel.innerHTML = "";
      (data || []).forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        sSel.appendChild(opt);
      });

      setStatus(`Studios loaded: ${(data||[]).length}`);
    }catch(err){
      setStatus("Load studios failed: " + err.message);
    }
  }

  // -------------------- DASHBOARD SUMMARY --------------------
  async function loadDashboard(){
    try{
      setStatus("Loading dashboard summary...");
      const {month, year} = ym();

      // Endpoint: GET /api/dashboard/summary?month=1&year=2026
      const s = await api(`/api/dashboard/summary?month=${month}&year=${year}`);

      $("kpiUnpaidCount").textContent = (s && s.unpaidStudiosCount!=null) ? s.unpaidStudiosCount : "-";
      $("kpiUnpaidAmount").textContent = (s && s.totalUnpaidAmount!=null) ? formatAED(s.totalUnpaidAmount) : "-";
      $("unpaidDetails").textContent = (s && s.unpaidDetailsText) ? s.unpaidDetailsText : "(none)";

      setStatus("Dashboard loaded.");
    }catch(err){
      setStatus("Dashboard load failed: " + err.message);
    }
  }

  // -------------------- RECORD PAYMENT + UPLOAD MULTI EVIDENCE --------------------
  async function recordPayment(){
    try{
      const studioId = $("studioSel").value;
      if(!studioId){ alert("Select studio first."); return; }

      const paymentDate = $("payDate").value;
      const amount = parseFloat($("amount").value);
      if(!paymentDate){ alert("Select payment date."); return; }
      if(isNaN(amount) || amount<=0){ alert("Enter valid amount."); return; }

      const maintenance = parseFloat($("maintenance").value || "0") || 0;

      $("btnRecord").disabled = true;
      setStatus("Recording payment...");

      // 1) Record payment in backend (Google Sheet / DB logic)
      // Endpoint: POST /api/rent/record
      const body = { studioId, paymentDate, amount, maintenance };
      const saved = await api(`/api/rent/record`, {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });

      // 2) Upload evidence files (optional)
      const files = $("evidenceFiles").files;
      if(files && files.length>0){
        setStatus(`Payment recorded. Uploading evidence (${files.length})...`);
        const fd = new FormData();
        fd.append("studioId", studioId);
        fd.append("paymentDate", paymentDate);
        for(const f of files) fd.append("files", f);

        // Endpoint: POST /api/evidence/upload (multipart/form-data)
        await api(`/api/evidence/upload`, { method:"POST", body: fd });
      }

      // cleanup
      $("evidenceFiles").value = "";
      $("fileList").innerHTML = "<li>(none)</li>";
      $("amount").value = "";
      $("maintenance").value = "";

      setStatus("✅ Payment recorded and evidence uploaded.");
      await loadStudios();
      await loadDashboard();
    }catch(err){
      setStatus("Record failed: " + err.message);
      alert("Record failed: " + err.message);
    }finally{
      $("btnRecord").disabled = false;
    }
  }

  // -------------------- VERIFY PAID + DOCS --------------------
  async function verifyPaidDocs(){
    try{
      setStatus("Verifying Paid + Docs...");
      const {month, year} = ym();

      // Endpoint: GET /api/verify?month=1&year=2026
      const rows = await api(`/api/verify?month=${month}&year=${year}`);

      const tb = $("gridBody");
      tb.innerHTML = "";

      if(!rows || rows.length===0){
        tb.innerHTML = `<tr><td colspan="4" class="mini">No data.</td></tr>`;
        setStatus("No verification data.");
        return;
      }

      for(const r of rows){
        const tr = document.createElement("tr");
        tr.dataset.studioId = r.studioId;
        tr.dataset.docsCount = r.docsCount;

        const paidTag = r.paid ? `<span class="tag good">YES</span>` : `<span class="tag bad">NO</span>`;
        let statusTag = "";
        if(!r.paid) statusTag = `<span class="tag bad">UNPAID</span>`;
        else if(r.docsCount>0) statusTag = `<span class="tag good">PAID + DOCS</span>`;
        else statusTag = `<span class="tag warn">PAID but DOCS</span>`;

        tr.innerHTML = `
          <td>${escapeHtml(r.studioId || "")}</td>
          <td>${paidTag}</td>
          <td>${r.docsCount ?? 0}</td>
          <td>${statusTag} <span class="mini"> ${escapeHtml(r.status || "")}</span></td>
        `;

        tr.addEventListener("dblclick", async ()=>{
          await openEvidencePreview(r.studioId, month, year);
        });

        tb.appendChild(tr);
      }

      setStatus("✅ Verification completed. Double-click any row to preview evidence.");
    }catch(err){
      setStatus("Verify failed: " + err.message);
      alert("Verify failed: " + err.message);
    }
  }

  // -------------------- PREVIEW EVIDENCE (DOUBLE CLICK) --------------------
  async function openEvidencePreview(studioId, month, year){
    try{
      setStatus(`Loading evidence list for ${studioId} (${month}/${year})...`);

      // Endpoint: GET /api/evidence/list?studioId=...&month=...&year=...
      const files = await api(`/api/evidence/list?studioId=${encodeURIComponent(studioId)}&month=${month}&year=${year}`);

      if(!files || files.length===0){
        alert("No evidence found for this Studio/Month/Year.");
        setStatus("No evidence found.");
        return;
      }

      if(files.length===1){
        window.open(files[0].webViewLink, "_blank");
        setStatus("Opened evidence in new tab.");
        return;
      }

      // Multiple files -> prompt simple chooser
      const names = files.map((f,i)=> `${i+1}) ${f.name}`).join("\n");
      const pick = prompt("Multiple evidence files found.\nEnter file number to open:\n\n" + names, "1");
      const idx = parseInt(pick,10)-1;
      if(isNaN(idx) || idx<0 || idx>=files.length) return;

      window.open(files[idx].webViewLink, "_blank");
      setStatus("Opened evidence in new tab.");
    }catch(err){
      setStatus("Evidence preview failed: " + err.message);
      alert("Evidence preview failed: " + err.message);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function boot(){
    fillMonthYear();
    wire();
    await loadStudios();
    await loadDashboard();
  }
  boot();
</script>
</body>
</html>
