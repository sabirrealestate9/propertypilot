<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rent Records - Sabir Amin Real Estate Company LLC</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Use SAME design from your app.css -->
  <link rel="stylesheet" href="app.css" />
</head>

<body>

  <!-- Loading + Error (kept) -->
  <div id="ppLoading" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(245,247,250,0.85);z-index:9999;">
    <div style="background:white;padding:16px 18px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.12);display:flex;align-items:center;gap:10px;font-family:Inter, sans-serif;">
      <i class="fas fa-spinner fa-spin" style="color:#00bcd4;"></i>
      <span style="font-size:14px;color:#37474f;font-weight:800;">Loading live data…</span>
    </div>
  </div>

  <div id="ppError" style="display:none;margin:12px 0;padding:12px 14px;border-radius:10px;border:1px solid rgba(244,67,54,0.35);background:rgba(244,67,54,0.08);color:#b71c1c;font-family:Inter, sans-serif;font-size:13px;font-weight:800;"></div>

  <!-- Toast (kept) -->
  <div class="toast" id="toast" style="position:fixed;right:18px;bottom:18px;display:none;align-items:center;gap:10px;padding:12px 14px;border-radius:14px;background:#fff;border:1px solid rgba(0,0,0,0.06);box-shadow:0 10px 24px rgba(0,0,0,0.10);z-index:9999;max-width:520px;">
    <i class="fas fa-circle-check" style="color:#00bcd4;"></i>
    <div>
      <div class="msg" id="toastMsg" style="font-size:13px;font-weight:800;color:#263238;">Done</div>
      <div class="sub" id="toastSub" style="display:none;font-size:12px;font-weight:700;color:#546e7a;margin-top:2px;"></div>
    </div>
  </div>

  <!-- Sidebar (same structure) -->
  <nav class="sidebar">
    <div class="logo">
      <div class="logo-icon"><i class="fas fa-gem"></i></div>
      <span class="logo-text">Opal</span>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Main</div>
      <a href="index.html" class="nav-link"><i class="fas fa-th-large"></i>Dashboard</a>
      <a href="properties.html" class="nav-link"><i class="fas fa-building"></i>Properties</a>
      <a href="rent-records.html" class="nav-link active">
        <i class="fas fa-file-invoice-dollar"></i>Rent Records
        <span class="nav-badge" id="rentBadge">3</span>
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Finance</div>
      <a href="transactions.html" class="nav-link"><i class="fas fa-exchange-alt"></i>Transactions</a>
      <a href="recurring-expenses.html" class="nav-link"><i class="fas fa-redo"></i>Recurring Expenses</a>
      <a href="monthly-profit.html" class="nav-link"><i class="fas fa-chart-line"></i>Monthly Profit</a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Reports</div>
      <a href="reports.html" class="nav-link"><i class="fas fa-chart-bar"></i>Reports</a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">System</div>
      <a href="settings.html" class="nav-link"><i class="fas fa-cog"></i>Settings</a>
    </div>
  </nav>

  <!-- Main -->
  <main class="main-content">
    <header class="page-header">
      <div class="page-title">
        <h1>Rent Records</h1>
        <p>Track rent payments, unpaid studios, payment history, and reminders (Google Sheet integrated).</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" id="exportBtn"><i class="fas fa-download"></i> Export CSV</button>
        <button class="btn btn-secondary" id="syncBtn"><i class="fas fa-rotate"></i> Refresh</button>
        <button class="btn btn-primary" id="openEntryBtn"><i class="fas fa-plus"></i> Record Monthly Rent</button>
      </div>
    </header>

    <!-- Summary Strip (kept) -->
    <section class="summary-strip" aria-label="Monthly summary">
      <div class="summary-card income">
        <div class="summary-value" id="sumReceived">—</div>
        <div class="summary-label">Total Received (Selected Month)</div>
      </div>
      <div class="summary-card due">
        <div class="summary-value" id="sumDue">—</div>
        <div class="summary-label">Total Due (Selected Month)</div>
      </div>
      <div class="summary-card overdue">
        <div class="summary-value" id="sumOverdue">—</div>
        <div class="summary-label">Overdue Studios</div>
      </div>
      <div class="summary-card pending">
        <div class="summary-value" id="sumPending">—</div>
        <div class="summary-label">Pending This Week</div>
      </div>
    </section>

    <!-- Filters (kept) -->
    <section class="filters-bar" aria-label="Filters">
      <div class="filters-left">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input id="searchInput" type="text" placeholder="Search tenant / unit / owner / contact…" />
        </div>

        <select class="filter-select" id="statusFilter">
          <option value="all">All Status</option>
          <option value="paid">Paid</option>
          <option value="pending">Pending</option>
          <option value="overdue">Overdue</option>
        </select>

        <select class="filter-select" id="propertyFilter">
          <option value="all">All Units</option>
        </select>
      </div>

      <div class="filters-right">
        <select class="filter-select" id="monthFilter"></select>
        <select class="filter-select" id="yearFilter"></select>
      </div>
    </section>

    <!-- Rent Entry (kept) -->
    <section class="card" aria-label="Record monthly rent" id="rentEntryCard">
      <div class="card-header">
        <div>
          <div class="card-title"><i class="fas fa-pen-to-square"></i> Record Monthly Rent</div>
          <div class="card-sub">Post a rent payment to Google Sheet, view unpaid studios, and see payment history.</div>
        </div>
        <div class="split-actions">
          <div class="checkbox" title="Show only unpaid studios in the Studio list">
            <input type="checkbox" id="onlyUnpaidChk" checked />
            <span>Show Only Unpaid Studios</span>
          </div>
          <button class="btn btn-secondary" id="toggleEntryBtn" title="Collapse / Expand">
            <i class="fas fa-chevron-up"></i> Collapse
          </button>
        </div>
      </div>

      <div class="card-body" id="entryBody">
        <div class="entry-top" style="margin-bottom:12px;">
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <label style="font-size:13px;font-weight:900;color:var(--text-secondary);">Month:</label>
            <select class="filter-select" id="entryMonth"></select>

            <label style="font-size:13px;font-weight:900;color:var(--text-secondary);">Year:</label>
            <select class="filter-select" id="entryYear"></select>
          </div>

          <div style="margin-left:auto;display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-secondary" id="bulkReminderBtn" title="Send reminders to all unpaid (hook)">
              <i class="fas fa-envelope"></i> Email Unpaid (Bulk)
            </button>
            <button class="btn btn-danger" id="clearFormBtn" title="Clear entry form">
              <i class="fas fa-eraser"></i> Clear
            </button>
          </div>
        </div>

        <div class="rent-entry-grid">
          <!-- Left: Entry Form -->
          <div class="entry-form">
            <div class="form-row">
              <label>Studio ID:</label>
              <select class="control" id="studioSelect"></select>
            </div>

            <div class="form-row">
              <label>Payment Date:</label>
              <input class="control" id="paymentDate" type="date" />
            </div>

            <div class="form-row">
              <label>Amount:</label>
              <input class="control" id="amountInput" type="number" step="0.01" placeholder="e.g. 2600" />
            </div>

            <div class="form-row">
              <label>Maintenance:</label>
              <input class="control" id="maintenanceInput" type="number" step="0.01" placeholder="optional" />
            </div>

            <div class="form-row">
              <label>Payment Method:</label>
              <select class="control" id="paymentMethod">
                <option value="Cash">Cash</option>
                <option value="Bank Transfer">Bank Transfer</option>
                <option value="Cheque">Cheque</option>
                <option value="Card">Card</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="form-row">
              <label>Notes:</label>
              <input class="control" id="notesInput" type="text" placeholder="e.g. Transfer ref, partial, remarks…" />
            </div>

            <div class="form-actions">
              <button class="btn btn-primary" id="recordPaymentBtn">
                <i class="fas fa-circle-check"></i> Record Payment
              </button>
              <button class="btn btn-secondary" id="emailReminderBtn">
                <i class="fas fa-envelope"></i> Email Reminder
              </button>
            </div>

            <div style="margin-top:10px;font-size:12px;color:var(--text-secondary);font-weight:800;">
              Tip: Unpaid is calculated by Studios sheet MINUS RentRecords sheet for selected month/year.
            </div>
          </div>

          <!-- Right: Unpaid Panel -->
          <div class="unpaid-panel">
            <div class="unpaid-head">
              <div class="unpaid-title" id="unpaidTitle">Unpaid Studios for —</div>
              <div class="unpaid-meta" id="unpaidMeta">—</div>
            </div>

            <div class="unpaid-stats">
              <div id="unpaidCount">Total Unpaid Studios: —</div>
              <div id="unpaidAmount">Total Unpaid Amount: —</div>
            </div>

            <div class="unpaid-list" id="unpaidList">Loading…</div>
          </div>
        </div>

        <!-- Payment History (kept) -->
        <div style="height:14px;"></div>
        <div class="card" style="border-radius: var(--radius-lg);">
          <div class="card-header">
            <div>
              <div class="card-title"><i class="fas fa-clock-rotate-left"></i> Payment History</div>
              <div class="card-sub">History for selected studio (latest first)</div>
            </div>
            <button class="btn btn-secondary" id="historyRefreshBtn">
              <i class="fas fa-rotate"></i> Refresh History
            </button>
          </div>
          <div class="table-container">
            <table style="min-width: 760px;">
              <thead>
                <tr>
                  <th>Payment Date</th>
                  <th>Amount</th>
                  <th>Maintenance</th>
                  <th>Month</th>
                  <th>Year</th>
                  <th>Method</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="historyTbody"></tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <!-- Rent Records Table (kept) -->
    <section class="card" aria-label="Rent records table" style="margin-top:16px;">
      <div class="card-header">
        <div>
          <div class="card-title"><i class="fas fa-table"></i> Rent Records</div>
          <div class="card-sub">Filtered by status / unit / month-year • Live data from Google Sheet</div>
        </div>
        <div class="split-actions">
          <button class="btn btn-secondary" id="markPaidBtn" title="Mark selected row as paid (hook)">
            <i class="fas fa-check"></i> Mark Paid
          </button>
          <button class="btn btn-secondary" id="openInSheetBtn" title="Open Sheet (requires link in app-config)">
            <i class="fas fa-up-right-from-square"></i> Open Sheet
          </button>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Tenant</th>
              <th>Unit</th>
              <th>Due Date</th>
              <th>Amount</th>
              <th>Received Date</th>
              <th>Payment Method</th>
              <th>Status</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rentRecordsTbody"></tbody>
        </table>
      </div>

      <div class="pagination">
        <div class="pagination-info" id="pageInfo">Showing 0–0 of 0 records</div>
        <div class="pagination-controls">
          <button class="pagination-btn" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
          <button class="pagination-btn active" id="pageBtn">1</button>
          <button class="pagination-btn" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
    </section>
  </main>

  <!-- Your shared app files (kept) -->
  <script src="app-config.js"></script>
  <script src="app.js"></script>
  <script src="app-data.js"></script>

  <script>
    /*********************************************************************
     * RENT-RECORDS.HTML (UPDATED)
     * - Keeps design/structure unchanged
     * - Adds a complete API fallback wrapper if app-data.js is missing APIs
     * - Adds mobile-safe fetch + clear errors if HTML returned
     * - Adds: record payment, fetch data, history, export CSV, reminders hooks
     *********************************************************************/

    const $ = (id) => document.getElementById(id);

    const ppLoading = $("ppLoading");
    const ppError = $("ppError");

    const toast = $("toast");
    const toastMsg = $("toastMsg");
    const toastSub = $("toastSub");

    const CURRENCY = (window.APP_CONFIG && window.APP_CONFIG.CURRENCY) || "AED";
    const API_URL =
      (window.APP_CONFIG && (window.APP_CONFIG.API_URL || window.APP_CONFIG.GAS_WEBAPP_URL)) ||
      ""; // If empty, your app-data.js must provide API functions

    const FETCH_TIMEOUT_MS = 15000;

    function showToast(message, sub) {
      toastMsg.textContent = message || "Done";
      if (sub) {
        toastSub.style.display = "";
        toastSub.textContent = sub;
      } else {
        toastSub.style.display = "none";
        toastSub.textContent = "";
      }
      toast.style.display = "flex";
      setTimeout(() => { toast.style.display = "none"; }, 2600);
    }

    function setLoading(on) { ppLoading.style.display = on ? "flex" : "none"; }

    function setError(msg) {
      if (!msg) { ppError.style.display = "none"; ppError.textContent = ""; return; }
      ppError.style.display = "block";
      ppError.textContent = msg;
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // --------------------------
    // Mobile-safe fetch helpers
    // --------------------------
    async function fetchWithTimeout(url, options = {}, timeoutMs = 15000) {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), timeoutMs);
      try {
        return await fetch(url, {
          ...options,
          signal: controller.signal,
          mode: "cors",
          redirect: "follow",
          cache: "no-store"
        });
      } finally {
        clearTimeout(t);
      }
    }

    async function callApi(action, payload) {
      if (!API_URL) {
        throw new Error("API_URL not configured. Add API_URL in app-config.js or provide window.PropertyPilotApi in app-data.js.");
      }

      // Use POST JSON by default (recommended for Apps Script)
      const url = new URL(API_URL);
      url.searchParams.set("_ts", String(Date.now())); // cache buster

      const res = await fetchWithTimeout(url.toString(), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action, ...(payload || {}) })
      }, FETCH_TIMEOUT_MS);

      const text = await res.text();
      const trimmed = (text || "").trim();

      // detect HTML redirect page (common on mobile if GAS not public)
      const looksLikeHtml =
        trimmed.startsWith("<!DOCTYPE") ||
        trimmed.startsWith("<html") ||
        trimmed.includes("<head") ||
        trimmed.includes("<body");

      if (looksLikeHtml) {
        throw new Error(
          "API returned HTML instead of JSON.\n\n" +
          "Most common cause: Google Apps Script Web App is not public (mobile gets redirected).\n\n" +
          "Fix:\n" +
          "Apps Script → Deploy → New deployment → Web app\n" +
          "Execute as: Me\n" +
          "Who has access: Anyone\n" +
          "Use the NEW /exec URL in app-config.js as API_URL."
        );
      }

      let json;
      try { json = JSON.parse(trimmed); }
      catch {
        throw new Error("API did not return valid JSON.\n\nFirst 250 chars:\n" + trimmed.slice(0, 250));
      }

      if (!res.ok) throw new Error(`API error: HTTP ${res.status}\n` + (json.error || trimmed.slice(0, 250)));
      if (json && json.ok === false) throw new Error(json.error || "API returned ok=false");
      return json;
    }

    // --------------------------
    // API getter (uses your app-data.js if present, otherwise fallback to GAS)
    // --------------------------
    function getAPI() {
      const existing = window.PropertyPilotApi || window.PropertyPilot;
      if (existing) return existing;

      // Provide fallback API wrapper (no design changes)
      const api = {
        sheetUrl: (window.APP_CONFIG && window.APP_CONFIG.SHEET_URL) || "",

        async getStudios() {
          const r = await callApi("getStudios", {});
          return r.studios || r.data || [];
        },

        async getProperties() {
          // fallback if you store studios in a "Table" sheet
          const r = await callApi("getProperties", {});
          return r.properties || r.data || [];
        },

        async getRentRecords({ month, year }) {
          const r = await callApi("getRentRecords", { month, year });
          return r.records || r.rentRecords || r.data || [];
        },

        async getPaymentHistory({ studioId }) {
          const r = await callApi("getPaymentHistory", { studioId });
          return r.history || r.records || r.data || [];
        },

        async addRentPayment(payload) {
          // payload: studioId, month, year, paymentDate, amount, maintenance, notes, method
          const r = await callApi("addRentPayment", payload);
          return r;
        },

        async exportCsv({ month, year }) {
          const r = await callApi("exportCsv", { month, year });
          // expecting { csv: "..." }
          return r.csv || "";
        },

        async sendReminder({ studioId, month, year }) {
          const r = await callApi("sendReminder", { studioId, month, year });
          return r;
        },

        async sendBulkReminder({ month, year }) {
          const r = await callApi("sendBulkReminder", { month, year });
          return r;
        },

        async markPaid({ studioId, month, year }) {
          const r = await callApi("markPaid", { studioId, month, year });
          return r;
        }
      };

      window.PropertyPilotApi = api;
      return api;
    }

    // ---- State
    const State = {
      records: [],
      filtered: [],
      studios: [],      // Studios sheet data (or fallback)
      properties: [],   // kept
      unpaid: { studios: [], totalUnpaid: 0, totalAmount: 0 },
      page: 1,
      pageSize: 12,
      selectedRowStudioId: ""
    };

    // ---- Helpers
    function pad2(n) { return String(n).padStart(2, "0"); }

    function normalizeId(v) {
      return String(v ?? "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, " ");
    }

    function toMoney(n, currency) {
      const v = Number(n || 0);
      if (!isFinite(v)) return "—";
      try {
        return new Intl.NumberFormat("en-AE", { style: "currency", currency: currency || "AED" }).format(v);
      } catch {
        return v.toLocaleString(undefined, { maximumFractionDigits: 2 }) + (currency ? ` ${currency}` : "");
      }
    }

    function initials(name) {
      const s = String(name || "").trim();
      if (!s || s === "—" || s === "-") return "NA";
      return s.split(/\s+/).slice(0,2).map(p => (p[0] || "").toUpperCase()).join("");
    }

    function normalizeStatus(s) {
      const v = String(s || "").toLowerCase();
      if (v === "paid") return "paid";
      if (v === "overdue") return "overdue";
      return "pending";
    }

    function fillMonthSelect(sel) {
      const months = [
        { v: 1, t: "January" }, { v: 2, t: "February" }, { v: 3, t: "March" }, { v: 4, t: "April" },
        { v: 5, t: "May" }, { v: 6, t: "June" }, { v: 7, t: "July" }, { v: 8, t: "August" },
        { v: 9, t: "September" }, { v: 10, t: "October" }, { v: 11, t: "November" }, { v: 12, t: "December" },
      ];
      sel.innerHTML = months.map(m => `<option value="${m.v}">${m.t}</option>`).join("");
    }

    function fillYearSelect(sel, baseYear) {
      const y = baseYear || new Date().getFullYear();
      const years = [];
      for (let i = y - 3; i <= y + 2; i++) years.push(i);
      sel.innerHTML = years.map(v => `<option value="${v}">${v}</option>`).join("");
    }

    function getSelectedMonthYear() {
      return { month: Number($("monthFilter").value), year: Number($("yearFilter").value) };
    }

    function syncEntryMonthYear() {
      $("entryMonth").value = $("monthFilter").value;
      $("entryYear").value = $("yearFilter").value;
    }

    function syncFilterMonthYear() {
      $("monthFilter").value = $("entryMonth").value;
      $("yearFilter").value = $("entryYear").value;
    }

    // ---- Core FIX: compute unpaid from Studios sheet vs RentRecords sheet
    function computeUnpaidStudios(studios, rentRecords, month, year) {
      const paidSet = new Set();

      for (const r of (rentRecords || [])) {
        const rMonth = Number(r.month ?? r.Month ?? r.rentMonth ?? r.RentMonth ?? month);
        const rYear  = Number(r.year ?? r.Year ?? r.rentYear ?? r.RentYear ?? year);

        if (rMonth !== Number(month) || rYear !== Number(year)) continue;

        const studioId = normalizeId(r.studioId ?? r.StudioId ?? r.unitId ?? r.UnitId ?? r.Studio ?? "");
        if (!studioId) continue;

        const status = normalizeStatus(r.status ?? r.Status);
        const received = String(r.receivedDate ?? r.ReceivedDate ?? r.paymentDate ?? r.PaymentDate ?? "").trim();
        const amount = Number(r.amount ?? r.Amount ?? 0);

        const isPaid = status === "paid" || !!received || (isFinite(amount) && amount > 0);
        if (isPaid) paidSet.add(studioId);
      }

      const unpaid = [];
      for (const s of (studios || [])) {
        const sid = normalizeId(
          s.studioId ?? s.StudioId ?? s.unitId ?? s.UnitId ?? s.ID ?? s.Id ?? s["Studio ID"] ?? s.Location ?? ""
        );
        if (!sid) continue;

        const activeFlag = String(s.active ?? s.Active ?? s.status ?? s.Status ?? "active").toLowerCase();
        if (activeFlag.includes("inactive") || activeFlag.includes("closed")) continue;

        if (!paidSet.has(sid)) {
          unpaid.push({
            studioId: s.studioId ?? s.StudioId ?? s.unitId ?? s.UnitId ?? s.ID ?? s.Id ?? s["Studio ID"] ?? s.Location ?? "",
            unit: s.unit ?? s.Unit ?? s.unitName ?? s["Unit"] ?? s["Unit Name"] ?? s.Flat ?? "",
            tenant: s.tenant ?? s.Tenant ?? s.TenantName ?? s["Tenant"] ?? "",
            owner: s.owner ?? s.Owner ?? s.OwnerName ?? s["Owner"] ?? "",
            contact: s.contact ?? s.Contact ?? s.TenantContact ?? s["Contact"] ?? s["Mobile"] ?? "",
            rent: Number(s.rent ?? s.Rent ?? s.TenantRent ?? s["Rent"] ?? s["Monthly Rent"] ?? 0),
            type: s.type ?? s.Type ?? s.Property ?? s["Property Type"] ?? ""
          });
        }
      }

      const totalAmount = unpaid.reduce((a, b) => a + (Number(b.rent) || 0), 0);
      return { studios: unpaid, totalUnpaid: unpaid.length, totalAmount };
    }

    // ---- Renderers
    function renderPropertyFilter() {
      const sel = $("propertyFilter");

      // Prefer unique units
      const units = (State.studios || []).map(p => String(
        p.unit ?? p.Unit ?? p.unitName ?? p["Unit"] ?? p["Unit Name"] ?? p.Flat ?? p.Location ?? ""
      ).trim()).filter(Boolean);

      const uniqueUnits = Array.from(new Set(units)).sort((a,b)=>a.localeCompare(b));

      const list = [`<option value="all">All Units</option>`].concat(
        uniqueUnits.map(u => `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`)
      );
      sel.innerHTML = list.join("");
    }

    function renderStudioSelect() {
      const sel = $("studioSelect");
      const onlyUnpaid = $("onlyUnpaidChk").checked;

      const list = onlyUnpaid
        ? (State.unpaid.studios || [])
        : (State.studios || []).map(s => ({
            studioId: s.studioId ?? s.StudioId ?? s.unitId ?? s.UnitId ?? s.ID ?? s.Id ?? s["Studio ID"] ?? s.Location ?? "",
            unit: s.unit ?? s.Unit ?? s.unitName ?? s["Unit"] ?? s["Unit Name"] ?? s.Flat ?? "",
            tenant: s.tenant ?? s.Tenant ?? s.TenantName ?? s["Tenant"] ?? "—",
          }));

      sel.innerHTML = list.length
        ? list.map(s => `<option value="${escapeHtml(s.studioId)}">${escapeHtml(s.studioId)} • ${escapeHtml(s.unit || "")} • ${escapeHtml(s.tenant || "—")}</option>`).join("")
        : `<option value="">No studios available</option>`;

      if (!sel.value && list.length) sel.value = String(list[0].studioId || "");
    }

    function renderUnpaidPanel() {
      const month = Number($("entryMonth").value);
      const year = Number($("entryYear").value);

      $("unpaidTitle").textContent = `Unpaid Studios for ${month}/${year}:`;
      $("unpaidMeta").textContent = `As of ${new Date().toLocaleDateString("en-GB")}`;

      $("unpaidCount").textContent = `Total Unpaid Studios: ${State.unpaid.totalUnpaid || 0}`;
      $("unpaidAmount").textContent = `Total Unpaid Amount: ${toMoney(State.unpaid.totalAmount || 0, CURRENCY)}`;

      const list = State.unpaid.studios || [];
      if (!list.length) { $("unpaidList").textContent = "No unpaid studios for this period."; return; }

      const lines = list.map(s => {
        const nm = s.tenant ? String(s.tenant) : "Vacant/Unknown";
        const unit = s.unit ? ` (${s.unit})` : "";
        const contact = s.contact ? `Contact: ${s.contact}` : "Contact: —";
        const rent = toMoney(s.rent, CURRENCY);
        const type = s.type ? ` • ${s.type}` : "";
        return `${s.studioId}${unit} - ${nm}${type}\nRent: ${rent}\n${contact}\n`;
      });

      $("unpaidList").textContent = lines.join("\n");
    }

    function renderSummary() {
      const rows = State.records || [];
      const received = rows
        .filter(r => normalizeStatus(r.status || r.Status) === "paid")
        .reduce((a, b) => a + Number(b.amount ?? b.Amount ?? 0), 0);

      const due = rows
        .filter(r => normalizeStatus(r.status || r.Status) !== "paid")
        .reduce((a, b) => a + Number(b.amount ?? b.Amount ?? 0), 0);

      const overdueCount = rows.filter(r => normalizeStatus(r.status || r.Status) === "overdue").length;

      // "Pending This Week" - if your sheet has dueDate, count within next 7 days; else use pending count
      const now = new Date();
      const in7 = new Date(now.getTime() + 7*24*60*60*1000);

      let pendingWeek = 0;
      for (const r of rows) {
        const st = normalizeStatus(r.status || r.Status);
        if (st !== "pending") continue;

        const dd = String(r.dueDate || r.DueDate || "").trim();
        if (!dd) { pendingWeek++; continue; }

        const d = new Date(dd);
        if (!isNaN(d.getTime()) && d >= now && d <= in7) pendingWeek++;
        else if (isNaN(d.getTime())) pendingWeek++;
      }

      $("sumReceived").textContent = toMoney(received, CURRENCY);
      $("sumDue").textContent = toMoney(due, CURRENCY);
      $("sumOverdue").textContent = String(overdueCount);
      $("sumPending").textContent = String(pendingWeek);
    }

    function applyFilters() {
      const q = ($("searchInput").value || "").trim().toLowerCase();
      const statusFilter = $("statusFilter").value;
      const unitFilter = $("propertyFilter").value;

      State.filtered = (State.records || []).filter(r => {
        const tenant = String(r.tenant || r.Tenant || r.TenantName || "");
        const unit = String(r.unit || r.Unit || r.Flat || r.Location || "");
        const owner = String(r.owner || r.Owner || r.OwnerName || "");
        const contact = String(r.contact || r.Contact || r.TenantContact || "");
        const notes = String(r.notes || r.Notes || "");
        const hay = `${tenant} ${unit} ${owner} ${contact} ${notes}`.toLowerCase();

        const status = normalizeStatus(r.status || r.Status);

        const matchesQ = !q || hay.includes(q);
        const matchesStatus = statusFilter === "all" || status === statusFilter;
        const matchesUnit = unitFilter === "all" || unit === unitFilter;

        return matchesQ && matchesStatus && matchesUnit;
      });

      State.page = 1;
    }

    function renderTable() {
      const tbody = $("rentRecordsTbody");
      tbody.innerHTML = "";

      const total = (State.filtered || []).length;
      const start = (State.page - 1) * State.pageSize;
      const end = Math.min(start + State.pageSize, total);
      const pageRows = (State.filtered || []).slice(start, end);

      pageRows.forEach(r => {
        const tenant = String(r.tenant || r.Tenant || r.TenantName || "—");
        const unit = String(r.unit || r.Unit || r.Flat || r.Location || "—");
        const dueDate = String(r.dueDate || r.DueDate || "—");
        const amount = Number(r.amount ?? r.Amount ?? 0);
        const receivedDate = String(r.receivedDate || r.ReceivedDate || r.paymentDate || r.PaymentDate || "—");
        const method = String(r.method || r.PaymentMethod || r.paymentMethod || "—");
        const status = normalizeStatus(r.status || r.Status);
        const notes = String(r.notes || r.Notes || "");
        const studioId = String(r.studioId || r.StudioId || r.unitId || r.UnitId || r.Location || "");

        const tr = document.createElement("tr");
        tr.dataset.studioId = studioId;

        tr.innerHTML = `
          <td>
            <div class="tenant-info">
              <div class="tenant-avatar">${escapeHtml(initials(tenant))}</div>
              <div>
                <div style="font-weight:1000;">${escapeHtml(tenant)}</div>
                <div style="font-size:12px;color:var(--text-secondary);font-weight:800;">${escapeHtml(studioId || "—")}</div>
              </div>
            </div>
          </td>
          <td><strong>${escapeHtml(unit)}</strong></td>
          <td>${escapeHtml(dueDate)}</td>
          <td>${escapeHtml(toMoney(amount, CURRENCY))}</td>
          <td>${escapeHtml(receivedDate || "—")}</td>
          <td>${escapeHtml(method || "—")}</td>
          <td><span class="status-badge ${escapeHtml(status)}">${escapeHtml(status.toUpperCase())}</span></td>
          <td style="max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${escapeAttr(notes)}">${escapeHtml(notes || "—")}</td>
          <td>
            <button class="action-btn primary" data-action="select" title="Load this studio into entry form">
              <i class="fas fa-arrow-right"></i> Select
            </button>
            <button class="action-btn" data-action="remind" title="Send reminder (hook)">
              <i class="fas fa-envelope"></i> Remind
            </button>
          </td>
        `;

        tbody.appendChild(tr);
      });

      $("pageInfo").textContent = total
        ? `Showing ${start + 1}–${end} of ${total} records`
        : `Showing 0–0 of 0 records`;

      $("prevBtn").disabled = State.page <= 1;
      $("nextBtn").disabled = end >= total;

      // badge = unpaid count (visual)
      const badge = $("rentBadge");
      if (badge) badge.textContent = String(State.unpaid.totalUnpaid || 0);
    }

    function renderHistory(history) {
      const tbody = $("historyTbody");
      tbody.innerHTML = "";

      const rows = Array.isArray(history) ? history : [];
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="7" style="color:var(--text-secondary);font-weight:800;">No history found for this studio.</td></tr>`;
        return;
      }

      rows.forEach(h => {
        const paymentDate = String(h.paymentDate || h.PaymentDate || "—");
        const amount = Number(h.amount ?? h.Amount ?? 0);
        const maintenance = Number(h.maintenance ?? h.Maintenance ?? 0);
        const month = String(h.month ?? h.Month ?? "—");
        const year = String(h.year ?? h.Year ?? "—");
        const method = String(h.method || h.PaymentMethod || h.paymentMethod || "—");
        const notes = String(h.notes || h.Notes || "");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(paymentDate)}</td>
          <td>${escapeHtml(toMoney(amount, CURRENCY))}</td>
          <td>${escapeHtml(toMoney(maintenance, CURRENCY))}</td>
          <td>${escapeHtml(month)}</td>
          <td>${escapeHtml(year)}</td>
          <td>${escapeHtml(method)}</td>
          <td>${escapeHtml(notes || "—")}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function refreshHistory() {
      const api = getAPI();
      const studioId = $("studioSelect").value;
      if (!studioId) { renderHistory([]); return; }
      const history = await api.getPaymentHistory({ studioId });
      renderHistory(history);
    }

    // Ensures record list has normalized fields used by UI
    function normalizeRentRecordRow(r) {
      const studioId = String(r.studioId ?? r.StudioId ?? r.unitId ?? r.UnitId ?? r.Location ?? "").trim();
      const unit = String(r.unit ?? r.Unit ?? r.Flat ?? r.Location ?? "").trim();

      return {
        studioId,
        unit,
        tenant: r.tenant ?? r.Tenant ?? r.TenantName ?? "",
        owner: r.owner ?? r.Owner ?? r.OwnerName ?? "",
        contact: r.contact ?? r.Contact ?? r.TenantContact ?? "",
        dueDate: r.dueDate ?? r.DueDate ?? r.Due ?? "",
        amount: Number(r.amount ?? r.Amount ?? 0),
        receivedDate: r.receivedDate ?? r.ReceivedDate ?? r.paymentDate ?? r.PaymentDate ?? "",
        method: r.method ?? r.PaymentMethod ?? r.paymentMethod ?? "",
        status: r.status ?? r.Status ?? "pending",
        notes: r.notes ?? r.Notes ?? ""
      };
    }

    async function refreshForPeriod() {
      const api = getAPI();
      const { month, year } = getSelectedMonthYear();

      // 1) RentRecords for selected month/year
      const recordsRaw = await api.getRentRecords({ month, year });
      const records = Array.isArray(recordsRaw) ? recordsRaw.map(normalizeRentRecordRow) : [];
      State.records = records;

      // 2) Load studios list from Studios sheet (preferred)
      let studios = [];
      if (typeof api.getStudios === "function") {
        studios = await api.getStudios();
      } else if (typeof api.getProperties === "function") {
        studios = await api.getProperties();
      }
      State.studios = Array.isArray(studios) ? studios : [];

      // Update unit dropdown using studios list
      renderPropertyFilter();

      // 3) Compute unpaid properly (Studios minus RentRecords for month/year)
      State.unpaid = computeUnpaidStudios(State.studios, State.records, month, year);

      renderUnpaidPanel();
      renderStudioSelect();

      applyFilters();
      renderSummary();
      renderTable();
    }

    function validateEntry() {
      const studioId = $("studioSelect").value;
      const paymentDate = $("paymentDate").value;
      const amount = Number($("amountInput").value);

      if (!studioId) return "Please select a Studio ID.";
      if (!paymentDate) return "Please select a Payment Date.";
      if (!isFinite(amount) || amount <= 0) return "Please enter a valid Amount > 0.";
      return "";
    }

    async function recordPayment() {
      const api = getAPI();
      const err = validateEntry();
      if (err) { setError(err); showToast("Validation failed", err); return; }
      setError("");

      const payload = {
        studioId: $("studioSelect").value,
        month: Number($("entryMonth").value),
        year: Number($("entryYear").value),
        paymentDate: $("paymentDate").value,
        amount: Number($("amountInput").value),
        maintenance: Number($("maintenanceInput").value || 0),
        notes: ($("notesInput").value || "").trim(),
        method: ($("paymentMethod").value || "Cash").trim()
      };

      try {
        setLoading(true);

        // Optional: avoid duplicates - if API supports it, it can reject duplicates.
        // Client-side soft check: if already paid in current loaded list, warn.
        const alreadyPaid = (State.records || []).some(r =>
          normalizeId(r.studioId) === normalizeId(payload.studioId) &&
          normalizeStatus(r.status) === "paid"
        );
        if (alreadyPaid) {
          showToast("Note", "This studio already shows as PAID for selected month/year. Recording again will create another entry.");
        }

        await api.addRentPayment(payload);

        setLoading(false);
        showToast("Payment recorded", `${payload.studioId} • ${payload.month}/${payload.year}`);

        syncFilterMonthYear();
        await refreshForPeriod();
        await refreshHistory();
      } catch (e) {
        setLoading(false);
        setError(e?.message || "Failed to record payment.");
      }
    }

    async function sendReminder(studioId) {
      const api = getAPI();
      const month = Number($("entryMonth").value);
      const year = Number($("entryYear").value);

      if (!studioId) {
        showToast("Select a studio", "Please select a Studio ID first.");
        return;
      }

      try {
        setLoading(true);
        await api.sendReminder({ studioId, month, year });
        setLoading(false);
        showToast("Reminder triggered", `${studioId} • ${month}/${year}`);
      } catch (e) {
        setLoading(false);
        setError(e?.message || "Failed to send reminder.");
      }
    }

    async function sendBulkReminder() {
      const api = getAPI();
      const month = Number($("entryMonth").value);
      const year = Number($("entryYear").value);

      try {
        setLoading(true);
        const res = await api.sendBulkReminder({ month, year });
        setLoading(false);
        showToast("Bulk reminder triggered", res?.count ? `${res.count} recipients` : `${month}/${year}`);
      } catch (e) {
        setLoading(false);
        setError(e?.message || "Failed to send bulk reminders.");
      }
    }

    async function exportCsv() {
      const api = getAPI();
      const { month, year } = getSelectedMonthYear();

      try {
        setLoading(true);
        const csv = await api.exportCsv({ month, year });

        if (!csv) {
          setLoading(false);
          showToast("No CSV returned", "Your API must return { csv: \"...\" }");
          return;
        }

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `rent-records_${year}-${pad2(month)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        setLoading(false);
        showToast("Exported CSV", `rent-records_${year}-${pad2(month)}.csv`);
      } catch (e) {
        setLoading(false);
        setError(e?.message || "Export failed.");
      }
    }

    function clearForm() {
      $("amountInput").value = "";
      $("maintenanceInput").value = "";
      $("notesInput").value = "";
      $("paymentMethod").value = "Cash";
      $("paymentDate").valueAsDate = new Date();
      showToast("Cleared", "Entry form reset");
    }

    function toggleEntry() {
      const body = $("entryBody");
      const btn = $("toggleEntryBtn");
      const isHidden = body.style.display === "none";
      body.style.display = isHidden ? "" : "none";
      btn.innerHTML = isHidden
        ? `<i class="fas fa-chevron-up"></i> Collapse`
        : `<i class="fas fa-chevron-down"></i> Expand`;
    }

    function applyAndRender() {
      applyFilters();
      renderTable();
    }

    // ---- HTML escaping (safety)
    function escapeHtml(str){
      return String(str ?? "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }
    function escapeAttr(str){
      return escapeHtml(str).replace(/`/g,"&#096;");
    }

    // ---- Events (kept + upgraded)
    $("searchInput").addEventListener("input", applyAndRender);
    $("statusFilter").addEventListener("change", applyAndRender);
    $("propertyFilter").addEventListener("change", applyAndRender);

    $("monthFilter").addEventListener("change", async () => {
      syncEntryMonthYear();
      await refreshForPeriod();
      await refreshHistory();
    });
    $("yearFilter").addEventListener("change", async () => {
      syncEntryMonthYear();
      await refreshForPeriod();
      await refreshHistory();
    });

    $("entryMonth").addEventListener("change", async () => {
      syncFilterMonthYear();
      await refreshForPeriod();
      await refreshHistory();
    });
    $("entryYear").addEventListener("change", async () => {
      syncFilterMonthYear();
      await refreshForPeriod();
      await refreshHistory();
    });

    $("onlyUnpaidChk").addEventListener("change", () => renderStudioSelect());
    $("studioSelect").addEventListener("change", () => refreshHistory());

    $("recordPaymentBtn").addEventListener("click", recordPayment);
    $("emailReminderBtn").addEventListener("click", () => sendReminder($("studioSelect").value));
    $("bulkReminderBtn").addEventListener("click", sendBulkReminder);

    $("historyRefreshBtn").addEventListener("click", refreshHistory);
    $("clearFormBtn").addEventListener("click", clearForm);
    $("toggleEntryBtn").addEventListener("click", toggleEntry);

    $("syncBtn").addEventListener("click", async () => {
      try {
        setError("");
        setLoading(true);
        await refreshForPeriod();
        await refreshHistory();
        setLoading(false);
        showToast("Refreshed", "Live data updated");
      } catch (e) {
        setLoading(false);
        setError(e?.message || "Refresh failed.");
      }
    });

    $("exportBtn").addEventListener("click", exportCsv);

    $("prevBtn").addEventListener("click", () => {
      if (State.page <= 1) return;
      State.page -= 1;
      renderTable();
    });

    $("nextBtn").addEventListener("click", () => {
      const total = (State.filtered || []).length;
      const maxPage = Math.max(1, Math.ceil(total / State.pageSize));
      if (State.page >= maxPage) return;
      State.page += 1;
      renderTable();
    });

    // Row actions + select highlight
    $("rentRecordsTbody").addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;

      const tr = btn.closest("tr");
      const studioId = tr?.dataset?.studioId || "";
      const action = btn.dataset.action;

      if (action === "select" && studioId) {
        $("studioSelect").value = studioId;
        await refreshHistory();
        showToast("Selected", studioId);
        $("rentEntryCard").scrollIntoView({ behavior: "smooth", block: "start" });
      }

      if (action === "remind" && studioId) {
        await sendReminder(studioId);
      }
    });

    // Mark Paid (optional hook) - will call API if implemented
    $("markPaidBtn").addEventListener("click", async () => {
      try {
        const api = getAPI();
        const { month, year } = getSelectedMonthYear();
        const studioId = $("studioSelect").value;

        if (!studioId) {
          showToast("Select a studio", "Choose a Studio ID then click Mark Paid.");
          return;
        }

        if (typeof api.markPaid !== "function") {
          showToast("Not configured", "Implement markPaid action in API (optional).");
          return;
        }

        setLoading(true);
        await api.markPaid({ studioId, month, year });
        setLoading(false);

        showToast("Marked paid", `${studioId} • ${month}/${year}`);
        await refreshForPeriod();
        await refreshHistory();
      } catch (e) {
        setLoading(false);
        setError(e?.message || "Mark Paid failed.");
      }
    });

    $("openInSheetBtn").addEventListener("click", () => {
      const api = getAPI();
      const url = api.sheetUrl || (window.APP_CONFIG && window.APP_CONFIG.SHEET_URL) || "";
      if (!url) {
        showToast("Sheet link not set", "Add SHEET_URL in app-config.js");
        return;
      }
      window.open(url, "_blank", "noopener,noreferrer");
    });

    $("openEntryBtn").addEventListener("click", () => {
      $("rentEntryCard").scrollIntoView({ behavior: "smooth", block: "start" });
      const body = $("entryBody");
      if (body.style.display === "none") toggleEntry();
    });

    // Keyboard convenience: Enter to record (when focus is in amount/notes)
    ["amountInput","maintenanceInput","notesInput"].forEach(id=>{
      const el = $(id);
      if (!el) return;
      el.addEventListener("keydown", (e)=>{
        if (e.key === "Enter") {
          e.preventDefault();
          recordPayment();
        }
      });
    });

    // ---- Init
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        setError("");
        setLoading(true);

        fillMonthSelect($("monthFilter"));
        fillMonthSelect($("entryMonth"));
        fillYearSelect($("yearFilter"), new Date().getFullYear());
        fillYearSelect($("entryYear"), new Date().getFullYear());

        const now = new Date();
        $("monthFilter").value = String(now.getMonth() + 1);
        $("yearFilter").value = String(now.getFullYear());
        syncEntryMonthYear();
        $("paymentDate").valueAsDate = new Date();

        // If API_URL is missing but app-data.js provides API, this will still work
        await refreshForPeriod();
        await refreshHistory();

        setLoading(false);
      } catch (e) {
        setLoading(false);
        setError(e?.message || "Initialization failed.");
      }
    });
  </script>
</body>
</html>
