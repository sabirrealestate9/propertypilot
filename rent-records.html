<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rent Records - Sabir Amin Real Estate Company LLC</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- IMPORTANT: Use the SAME design from your app.css (no feature removed) -->
  <link rel="stylesheet" href="app.css" />
</head>

<body>

  <!-- Loading + Error (kept) -->
  <div id="ppLoading" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(245,247,250,0.85);z-index:9999;">
    <div style="background:white;padding:16px 18px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.12);display:flex;align-items:center;gap:10px;font-family:Inter, sans-serif;">
      <i class="fas fa-spinner fa-spin" style="color:#00bcd4;"></i>
      <span style="font-size:14px;color:#37474f;font-weight:800;">Loading live data…</span>
    </div>
  </div>

  <div id="ppError" style="display:none;margin:12px 0;padding:12px 14px;border-radius:10px;border:1px solid rgba(244,67,54,0.35);background:rgba(244,67,54,0.08);color:#b71c1c;font-family:Inter, sans-serif;font-size:13px;font-weight:800;"></div>

  <!-- Toast (kept) -->
  <div class="toast" id="toast" style="position:fixed;right:18px;bottom:18px;display:none;align-items:center;gap:10px;padding:12px 14px;border-radius:14px;background:#fff;border:1px solid rgba(0,0,0,0.06);box-shadow:0 10px 24px rgba(0,0,0,0.10);z-index:9999;max-width:520px;">
    <i class="fas fa-circle-check" style="color:#00bcd4;"></i>
    <div>
      <div class="msg" id="toastMsg" style="font-size:13px;font-weight:800;color:#263238;">Done</div>
      <div class="sub" id="toastSub" style="display:none;font-size:12px;font-weight:700;color:#546e7a;margin-top:2px;"></div>
    </div>
  </div>

  <!-- Sidebar (same structure) -->
  <nav class="sidebar">
    <div class="logo">
      <div class="logo-icon"><i class="fas fa-gem"></i></div>
      <span class="logo-text">Opal</span>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Main</div>
      <a href="index.html" class="nav-link"><i class="fas fa-th-large"></i>Dashboard</a>
      <a href="properties.html" class="nav-link"><i class="fas fa-building"></i>Properties</a>
      <a href="rent-records.html" class="nav-link active">
        <i class="fas fa-file-invoice-dollar"></i>Rent Records
        <span class="nav-badge" id="rentBadge">3</span>
      </a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Finance</div>
      <a href="transactions.html" class="nav-link"><i class="fas fa-exchange-alt"></i>Transactions</a>
      <a href="recurring-expenses.html" class="nav-link"><i class="fas fa-redo"></i>Recurring Expenses</a>
      <a href="monthly-profit.html" class="nav-link"><i class="fas fa-chart-line"></i>Monthly Profit</a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">Reports</div>
      <a href="reports.html" class="nav-link"><i class="fas fa-chart-bar"></i>Reports</a>
    </div>

    <div class="nav-section">
      <div class="nav-section-title">System</div>
      <a href="settings.html" class="nav-link"><i class="fas fa-cog"></i>Settings</a>
    </div>
  </nav>

  <!-- Main -->
  <main class="main-content">
    <header class="page-header">
      <div class="page-title">
        <h1>Rent Records</h1>
        <p>Track rent payments, unpaid studios, payment history, and reminders (Google Sheet integrated).</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" id="exportBtn"><i class="fas fa-download"></i> Export CSV</button>
        <button class="btn btn-secondary" id="syncBtn"><i class="fas fa-rotate"></i> Refresh</button>
        <button class="btn btn-primary" id="openEntryBtn"><i class="fas fa-plus"></i> Record Monthly Rent</button>
      </div>
    </header>

    <!-- Summary Strip (kept) -->
    <section class="summary-strip" aria-label="Monthly summary">
      <div class="summary-card income">
        <div class="summary-value" id="sumReceived">—</div>
        <div class="summary-label">Total Received (Selected Month)</div>
      </div>
      <div class="summary-card due">
        <div class="summary-value" id="sumDue">—</div>
        <div class="summary-label">Total Due (Selected Month)</div>
      </div>
      <div class="summary-card overdue">
        <div class="summary-value" id="sumOverdue">—</div>
        <div class="summary-label">Overdue Studios</div>
      </div>
      <div class="summary-card pending">
        <div class="summary-value" id="sumPending">—</div>
        <div class="summary-label">Pending This Week</div>
      </div>
    </section>

    <!-- Filters (kept) -->
    <section class="filters-bar" aria-label="Filters">
      <div class="filters-left">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input id="searchInput" type="text" placeholder="Search tenant / unit / owner / contact…" />
        </div>

        <select class="filter-select" id="statusFilter">
          <option value="all">All Status</option>
          <option value="paid">Paid</option>
          <option value="pending">Pending</option>
          <option value="overdue">Overdue</option>
        </select>

        <select class="filter-select" id="propertyFilter">
          <option value="all">All Units</option>
        </select>
      </div>

      <div class="filters-right">
        <select class="filter-select" id="monthFilter"></select>
        <select class="filter-select" id="yearFilter"></select>
      </div>
    </section>

    <!-- Rent Entry (kept) -->
    <section class="card" aria-label="Record monthly rent" id="rentEntryCard">
      <div class="card-header">
        <div>
          <div class="card-title"><i class="fas fa-pen-to-square"></i> Record Monthly Rent</div>
          <div class="card-sub">Post a rent payment to Google Sheet, view unpaid studios, and see payment history.</div>
        </div>
        <div class="split-actions">
          <div class="checkbox" title="Show only unpaid studios in the Studio list">
            <input type="checkbox" id="onlyUnpaidChk" checked />
            <span>Show Only Unpaid Studios</span>
          </div>
          <button class="btn btn-secondary" id="toggleEntryBtn" title="Collapse / Expand">
            <i class="fas fa-chevron-up"></i> Collapse
          </button>
        </div>
      </div>

      <div class="card-body" id="entryBody">
        <div class="entry-top" style="margin-bottom:12px;">
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <label style="font-size:13px;font-weight:900;color:var(--text-secondary);">Month:</label>
            <select class="filter-select" id="entryMonth"></select>

            <label style="font-size:13px;font-weight:900;color:var(--text-secondary);">Year:</label>
            <select class="filter-select" id="entryYear"></select>
          </div>

          <div style="margin-left:auto;display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-secondary" id="bulkReminderBtn" title="Send reminders to all unpaid (hook)">
              <i class="fas fa-envelope"></i> Email Unpaid (Bulk)
            </button>
            <button class="btn btn-danger" id="clearFormBtn" title="Clear entry form">
              <i class="fas fa-eraser"></i> Clear
            </button>
          </div>
        </div>

        <div class="rent-entry-grid">
          <!-- Left: Entry Form -->
          <div class="entry-form">
            <div class="form-row">
              <label>Studio ID:</label>
              <select class="control" id="studioSelect"></select>
            </div>

            <div class="form-row">
              <label>Payment Date:</label>
              <input class="control" id="paymentDate" type="date" />
            </div>

            <div class="form-row">
              <label>Amount:</label>
              <input class="control" id="amountInput" type="number" step="0.01" placeholder="e.g. 2600" />
            </div>

            <div class="form-row">
              <label>Maintenance:</label>
              <input class="control" id="maintenanceInput" type="number" step="0.01" placeholder="optional" />
            </div>

            <div class="form-row">
              <label>Notes:</label>
              <input class="control" id="notesInput" type="text" placeholder="e.g. Cash, transfer ref, partial…" />
            </div>

            <div class="form-actions">
              <button class="btn btn-primary" id="recordPaymentBtn">
                <i class="fas fa-circle-check"></i> Record Payment
              </button>
              <button class="btn btn-secondary" id="emailReminderBtn">
                <i class="fas fa-envelope"></i> Email Reminder
              </button>
            </div>

            <div style="margin-top:10px;font-size:12px;color:var(--text-secondary);font-weight:800;">
              Tip: Studio list and unpaid panel are computed from your Sheet (RentRecords + Properties).
            </div>
          </div>

          <!-- Right: Unpaid Panel -->
          <div class="unpaid-panel">
            <div class="unpaid-head">
              <div class="unpaid-title" id="unpaidTitle">Unpaid Studios for —</div>
              <div class="unpaid-meta" id="unpaidMeta">—</div>
            </div>

            <div class="unpaid-stats">
              <div id="unpaidCount">Total Unpaid Studios: —</div>
              <div id="unpaidAmount">Total Unpaid Amount: —</div>
            </div>

            <div class="unpaid-list" id="unpaidList">Loading…</div>
          </div>
        </div>

        <!-- Payment History (kept) -->
        <div style="height:14px;"></div>
        <div class="card" style="border-radius: var(--radius-lg);">
          <div class="card-header">
            <div>
              <div class="card-title"><i class="fas fa-clock-rotate-left"></i> Payment History</div>
              <div class="card-sub">History for selected studio (latest first)</div>
            </div>
            <button class="btn btn-secondary" id="historyRefreshBtn">
              <i class="fas fa-rotate"></i> Refresh History
            </button>
          </div>
          <div class="table-container">
            <table style="min-width: 760px;">
              <thead>
                <tr>
                  <th>Payment Date</th>
                  <th>Amount</th>
                  <th>Maintenance</th>
                  <th>Month</th>
                  <th>Year</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="historyTbody"></tbody>
            </table>
          </div>
        </div>

      </div>
    </section>

    <!-- Rent Records Table (kept) -->
    <section class="card" aria-label="Rent records table" style="margin-top:16px;">
      <div class="card-header">
        <div>
          <div class="card-title"><i class="fas fa-table"></i> Rent Records</div>
          <div class="card-sub">Filtered by status / unit / month-year • Live data from Google Sheet</div>
        </div>
        <div class="split-actions">
          <button class="btn btn-secondary" id="markPaidBtn" title="Mark selected row as paid (hook)">
            <i class="fas fa-check"></i> Mark Paid
          </button>
          <button class="btn btn-secondary" id="openInSheetBtn" title="Open Sheet (requires link in app-config)">
            <i class="fas fa-up-right-from-square"></i> Open Sheet
          </button>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Tenant</th>
              <th>Unit</th>
              <th>Due Date</th>
              <th>Amount</th>
              <th>Received Date</th>
              <th>Payment Method</th>
              <th>Status</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rentRecordsTbody"></tbody>
        </table>
      </div>

      <div class="pagination">
        <div class="pagination-info" id="pageInfo">Showing 0–0 of 0 records</div>
        <div class="pagination-controls">
          <button class="pagination-btn" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
          <button class="pagination-btn active" id="pageBtn">1</button>
          <button class="pagination-btn" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
    </section>
  </main>

  <!-- Your shared app files (same design + same feature set) -->
  <script src="app-config.js"></script>
  <script src="app.js"></script>
  <script src="app-data.js"></script>

  <script>
    /*********************************************************************
     * Rent Records Page Controller
     * - Uses SAME design via app.css
     * - Keeps ALL features you already had:
     *    Summary, filters, rent entry, unpaid panel, payment history,
     *    export CSV, refresh, reminders hooks, open sheet, pagination,
     *    select row -> load studio, collapse/expand entry.
     * - Uses PropertyPilot / PropertyPilotApi from app-data.js (Google Sheet)
     * - Falls back to a demo adapter ONLY if none exists (no features removed)
     *********************************************************************/

    const $ = (id) => document.getElementById(id);

    const ppLoading = $("ppLoading");
    const ppError = $("ppError");

    const toast = $("toast");
    const toastMsg = $("toastMsg");
    const toastSub = $("toastSub");

    function showToast(message, sub) {
      if (!toast) return;
      toastMsg.textContent = message || "Done";
      if (sub) {
        toastSub.style.display = "";
        toastSub.textContent = sub;
      } else {
        toastSub.style.display = "none";
        toastSub.textContent = "";
      }
      toast.style.display = "flex";
      setTimeout(() => { toast.style.display = "none"; }, 2600);
    }

    function setLoading(on) {
      if (!ppLoading) return;
      ppLoading.style.display = on ? "flex" : "none";
    }

    function setError(msg) {
      if (!ppError) return;
      if (!msg) {
        ppError.style.display = "none";
        ppError.textContent = "";
        return;
      }
      ppError.style.display = "block";
      ppError.textContent = msg;
    }

    // Demo fallback (keeps UI usable without breaking; features remain)
    const DemoAPI = (() => {
      const properties = [
        { studioId: "z1 va2 r6", unit: "S_No 1", owner: "Shumon", tenant: "Mushtaq", contact: "545213199", rent: 2600, type: "Personnel" },
        { studioId: "z33 v1 r6", unit: "S_No 2", owner: "Shumon", tenant: "—", contact: "586861734", rent: 2550, type: "Personnel" },
        { studioId: "z20 v76 rF1", unit: "S_No 3", owner: "Shumon", tenant: "Kamran Ahmed", contact: "565470449", rent: 3400, type: "Personnel" },
        { studioId: "z16", unit: "S_No 4", owner: "Shaiful Islam", tenant: "Prajith", contact: "586861734", rent: 3200, type: "Personnel" },
      ];

      let rentRecords = [
        { studioId: "z1 va2 r6", tenant: "Mushtaq", unit: "S_No 1", dueDate: "2026-01-05", amount: 2600, receivedDate: "2026-01-09", method: "Cash", status: "paid", notes: "OK", owner: "Shumon", contact: "545213199" },
        { studioId: "z20 v76 rF1", tenant: "Kamran Ahmed", unit: "S_No 3", dueDate: "2026-01-05", amount: 3400, receivedDate: "", method: "", status: "overdue", notes: "Call today", owner: "Shumon", contact: "565470449" },
        { studioId: "z16", tenant: "Prajith", unit: "S_No 4", dueDate: "2026-01-05", amount: 3200, receivedDate: "", method: "", status: "pending", notes: "", owner: "Shaiful Islam", contact: "586861734" },
      ];

      const historyByStudio = {
        "z1 va2 r6": [
          { paymentDate: "2025-12-17", amount: 2600, maintenance: 0, month: 12, year: 2025, notes: "Personnel" },
          { paymentDate: "2025-11-29", amount: 2600, maintenance: 0, month: 11, year: 2025, notes: "Personnel" },
        ],
        "z20 v76 rF1": [
          { paymentDate: "2025-12-20", amount: 3400, maintenance: 0, month: 12, year: 2025, notes: "Personnel" },
        ],
      };

      return {
        sheetUrl: "",
        async getProperties() { return properties; },
        async getRentRecords({ month, year }) { return rentRecords; },
        async getUnpaidStudios({ month, year }) {
          const paid = new Set(rentRecords.filter(r => (r.status || "").toLowerCase() === "paid").map(r => r.studioId));
          const unpaid = properties.filter(p => !paid.has(p.studioId)).map(p => ({
            studioId: p.studioId,
            unit: p.unit,
            tenant: p.tenant,
            contact: p.contact,
            rent: p.rent,
            type: p.type,
            owner: p.owner,
          }));
          return {
            studios: unpaid,
            totalUnpaid: unpaid.length,
            totalAmount: unpaid.reduce((a, b) => a + (Number(b.rent) || 0), 0),
          };
        },
        async addRentPayment(payload) {
          const studio = properties.find(p => p.studioId === payload.studioId);
          if (!studio) throw new Error("Studio not found");
          const existing = rentRecords.find(r => r.studioId === payload.studioId);
          if (existing) {
            existing.receivedDate = payload.paymentDate;
            existing.amount = payload.amount;
            existing.method = payload.method || "Cash";
            existing.status = "paid";
            existing.notes = payload.notes || "";
          } else {
            rentRecords.unshift({
              studioId: payload.studioId,
              tenant: studio.tenant,
              unit: studio.unit,
              dueDate: `${payload.year}-${String(payload.month).padStart(2, "0")}-05`,
              amount: payload.amount,
              receivedDate: payload.paymentDate,
              method: payload.method || "Cash",
              status: "paid",
              notes: payload.notes || "",
              owner: studio.owner,
              contact: studio.contact,
            });
          }
          if (!historyByStudio[payload.studioId]) historyByStudio[payload.studioId] = [];
          historyByStudio[payload.studioId].unshift({
            paymentDate: payload.paymentDate,
            amount: payload.amount,
            maintenance: payload.maintenance || 0,
            month: payload.month,
            year: payload.year,
            notes: payload.notes || "",
          });
          return { ok: true };
        },
        async getPaymentHistory({ studioId }) { return historyByStudio[studioId] || []; },
        async sendReminder({ studioId, month, year }) { return { ok: true }; },
        async sendBulkReminder({ month, year }) { return { ok: true, count: 0 }; },
        async exportCsv({ month, year }) {
          const rows = await this.getRentRecords({ month, year });
          const headers = ["studioId", "tenant", "unit", "dueDate", "amount", "receivedDate", "method", "status", "notes", "owner", "contact"];
          return [headers.join(",")].concat(
            rows.map(r => headers.map(h => `"${String(r[h] ?? "").replaceAll('"', '""')}"`).join(","))
          ).join("\n");
        },
      };
    })();

    function getAPI() {
      return window.PropertyPilotApi || window.PropertyPilot || DemoAPI;
    }

    // State
    const State = {
      records: [],
      filtered: [],
      properties: [],
      unpaid: { studios: [], totalUnpaid: 0, totalAmount: 0 },
      page: 1,
      pageSize: 12,
    };

    // Helpers
    function pad2(n) { return String(n).padStart(2, "0"); }
    function initials(name) {
      const s = (name || "").trim();
      if (!s || s === "—" || s === "-") return "NA";
      const parts = s.split(/\s+/).slice(0, 2);
      return parts.map(p => (p[0] || "").toUpperCase()).join("");
    }
    function toMoney(n, currency) {
      const v = Number(n || 0);
      if (!isFinite(v)) return "—";
      return v.toLocaleString(undefined, { maximumFractionDigits: 2 }) + (currency ? ` ${currency}` : "");
    }
    function normalizeStatus(s) {
      const v = String(s || "").toLowerCase();
      if (v === "paid") return "paid";
      if (v === "overdue") return "overdue";
      return "pending";
    }

    // Month/Year selects
    function fillMonthSelect(sel) {
      const months = [
        { v: 1, t: "January" }, { v: 2, t: "February" }, { v: 3, t: "March" }, { v: 4, t: "April" },
        { v: 5, t: "May" }, { v: 6, t: "June" }, { v: 7, t: "July" }, { v: 8, t: "August" },
        { v: 9, t: "September" }, { v: 10, t: "October" }, { v: 11, t: "November" }, { v: 12, t: "December" },
      ];
      sel.innerHTML = months.map(m => `<option value="${m.v}">${m.t}</option>`).join("");
    }
    function fillYearSelect(sel, baseYear) {
      const y = baseYear || new Date().getFullYear();
      const years = [];
      for (let i = y - 3; i <= y + 2; i++) years.push(i);
      sel.innerHTML = years.map(v => `<option value="${v}">${v}</option>`).join("");
    }

    function getSelectedMonthYear() {
      return { month: Number($("monthFilter").value), year: Number($("yearFilter").value) };
    }
    function syncEntryMonthYear() {
      $("entryMonth").value = $("monthFilter").value;
      $("entryYear").value = $("yearFilter").value;
    }
    function syncFilterMonthYear() {
      $("monthFilter").value = $("entryMonth").value;
      $("yearFilter").value = $("entryYear").value;
    }

    // Render filters
    function renderPropertyFilter() {
      const sel = $("propertyFilter");
      const list = [`<option value="all">All Units</option>`].concat(
        (State.properties || []).map(p => {
          const unit = (p.unit || p.Unit || p.unitName || "").toString().trim();
          return `<option value="${unit}">${unit || "—"}</option>`;
        })
      );
      sel.innerHTML = list.join("");
    }

    function renderStudioSelect() {
      const sel = $("studioSelect");
      const onlyUnpaid = $("onlyUnpaidChk").checked;

      const studios = onlyUnpaid
        ? (State.unpaid.studios || [])
        : (State.properties || []).map(p => ({
            studioId: (p.studioId || p.unitId || p.id || "").toString().trim(),
            unit: (p.unit || "").toString().trim(),
            tenant: (p.tenant || "—").toString().trim(),
          }));

      sel.innerHTML = studios.length
        ? studios.map(s => `<option value="${s.studioId}">${s.studioId} • ${s.unit || ""} • ${s.tenant || "—"}</option>`).join("")
        : `<option value="">No studios available</option>`;

      if (!sel.value && studios.length) sel.value = studios[0].studioId;
    }

    // Unpaid panel
    function renderUnpaidPanel() {
      const month = Number($("entryMonth").value);
      const year = Number($("entryYear").value);

      $("unpaidTitle").textContent = `Unpaid Studios for ${month}/${year}:`;
      $("unpaidMeta").textContent = `As of ${new Date().toLocaleDateString("en-GB")}`;

      $("unpaidCount").textContent = `Total Unpaid Studios: ${State.unpaid.totalUnpaid || 0}`;
      $("unpaidAmount").textContent = `Total Unpaid Amount: ${toMoney(State.unpaid.totalAmount || 0, "AED")}`;

      const list = State.unpaid.studios || [];
      if (!list.length) {
        $("unpaidList").textContent = "No unpaid studios for this period.";
        return;
      }

      const lines = list.map(s => {
        const studioId = (s.studioId || "").toString().trim();
        const unit = (s.unit || "").toString().trim();
        const tenant = (s.tenant || "Vacant/Unknown").toString().trim();
        const type = (s.type || "").toString().trim();
        const contact = (s.contact || "—").toString().trim();
        const rent = toMoney(s.rent || 0, "AED");
        return `${studioId}${unit ? ` (${unit})` : ""} - ${tenant}${type ? ` • ${type}` : ""}\nRent: ${rent}\nContact: ${contact}\n`;
      });

      $("unpaidList").textContent = lines.join("\n");
    }

    // Summary
    function renderSummary() {
      const rows = State.records || [];
      const received = rows
        .filter(r => normalizeStatus(r.status || r.Status) === "paid")
        .reduce((a, b) => a + Number(b.amount ?? b.Amount ?? 0), 0);

      const due = rows
        .filter(r => normalizeStatus(r.status || r.Status) !== "paid")
        .reduce((a, b) => a + Number(b.amount ?? b.Amount ?? 0), 0);

      const overdueCount = rows.filter(r => normalizeStatus(r.status || r.Status) === "overdue").length;
      const pendingWeek = rows.filter(r => normalizeStatus(r.status || r.Status) === "pending").length;

      // Keep your prior behavior (QAR display in table summary)
      $("sumReceived").textContent = toMoney(received, "QAR");
      $("sumDue").textContent = toMoney(due, "QAR");
      $("sumOverdue").textContent = String(overdueCount);
      $("sumPending").textContent = String(pendingWeek);
    }

    // Filters apply
    function applyFilters() {
      const q = ($("searchInput").value || "").trim().toLowerCase();
      const statusFilter = $("statusFilter").value;
      const unitFilter = $("propertyFilter").value;

      State.filtered = (State.records || []).filter(r => {
        const tenant = String(r.tenant || r.Tenant || "");
        const unit = String(r.unit || r.Unit || "");
        const owner = String(r.owner || r.Owner || "");
        const contact = String(r.contact || r.Contact || "");
        const notes = String(r.notes || r.Notes || "");
        const hay = `${tenant} ${unit} ${owner} ${contact} ${notes}`.toLowerCase();

        const status = normalizeStatus(r.status || r.Status);

        const matchesQ = !q || hay.includes(q);
        const matchesStatus = statusFilter === "all" || status === statusFilter;
        const matchesUnit = unitFilter === "all" || unit === unitFilter;

        return matchesQ && matchesStatus && matchesUnit;
      });

      State.page = 1;
    }

    // Render rent records table
    function renderTable() {
      const tbody = $("rentRecordsTbody");
      tbody.innerHTML = "";

      const total = (State.filtered || []).length;
      const start = (State.page - 1) * State.pageSize;
      const end = Math.min(start + State.pageSize, total);
      const pageRows = (State.filtered || []).slice(start, end);

      pageRows.forEach(r => {
        const tenant = String(r.tenant || r.Tenant || "—");
        const unit = String(r.unit || r.Unit || "—");
        const dueDate = String(r.dueDate || r.DueDate || "—");
        const amount = Number(r.amount ?? r.Amount ?? 0);
        const receivedDate = String(r.receivedDate || r.ReceivedDate || r.paymentDate || r.PaymentDate || "—");
        const method = String(r.method || r.PaymentMethod || "—");
        const status = normalizeStatus(r.status || r.Status);
        const notes = String(r.notes || r.Notes || "");
        const studioId = String(r.studioId || r.StudioId || r.unitId || r.UnitId || "");

        const tr = document.createElement("tr");
        tr.dataset.studioId = studioId;

        tr.innerHTML = `
          <td>
            <div class="tenant-info">
              <div class="tenant-avatar">${initials(tenant)}</div>
              <div>
                <div style="font-weight:1000;">${tenant}</div>
                <div style="font-size:12px;color:var(--text-secondary);font-weight:800;">${studioId || "—"}</div>
              </div>
            </div>
          </td>
          <td><strong>${unit}</strong></td>
          <td>${dueDate}</td>
          <td>${toMoney(amount, "QAR")}</td>
          <td>${receivedDate || "—"}</td>
          <td>${method || "—"}</td>
          <td><span class="status-badge ${status}">${status.toUpperCase()}</span></td>
          <td style="max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${notes.replaceAll('"', '&quot;')}">${notes || "—"}</td>
          <td>
            <button class="action-btn primary" data-action="select" title="Load this studio into entry form">
              <i class="fas fa-arrow-right"></i> Select
            </button>
            <button class="action-btn" data-action="remind" title="Send reminder (hook)">
              <i class="fas fa-envelope"></i> Remind
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      $("pageInfo").textContent = total
        ? `Showing ${start + 1}–${end} of ${total} records`
        : `Showing 0–0 of 0 records`;

      $("prevBtn").disabled = State.page <= 1;
      $("nextBtn").disabled = end >= total;
    }

    // Payment history table
    function renderHistory(history) {
      const tbody = $("historyTbody");
      tbody.innerHTML = "";

      const rows = Array.isArray(history) ? history : [];
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="6" style="color:var(--text-secondary);font-weight:800;">No history found for this studio.</td></tr>`;
        return;
      }

      rows.forEach(h => {
        const paymentDate = String(h.paymentDate || h.PaymentDate || "—");
        const amount = Number(h.amount ?? h.Amount ?? 0);
        const maintenance = Number(h.maintenance ?? h.Maintenance ?? 0);
        const month = String(h.month ?? h.Month ?? "—");
        const year = String(h.year ?? h.Year ?? "—");
        const notes = String(h.notes || h.Notes || "");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${paymentDate}</td>
          <td>${toMoney(amount, "AED")}</td>
          <td>${toMoney(maintenance, "AED")}</td>
          <td>${month}</td>
          <td>${year}</td>
          <td>${notes || "—"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Data loading
    async function refreshForPeriod() {
      const api = getAPI();
      const { month, year } = getSelectedMonthYear();

      // Records
      const records = await api.getRentRecords({ month, year });
      State.records = Array.isArray(records) ? records : [];
      applyFilters();
      renderSummary();
      renderTable();

      // Unpaid
      const unpaid = await api.getUnpaidStudios({ month, year });
      State.unpaid = unpaid || { studios: [], totalUnpaid: 0, totalAmount: 0 };
      State.unpaid.studios = Array.isArray(State.unpaid.studios) ? State.unpaid.studios : [];
      State.unpaid.totalUnpaid = Number(State.unpaid.totalUnpaid ?? State.unpaid.studios.length ?? 0);
      State.unpaid.totalAmount = Number(State.unpaid.totalAmount ?? 0);

      renderUnpaidPanel();
      renderStudioSelect();
    }

    async function refreshHistory() {
      const api = getAPI();
      const studioId = $("studioSelect").value;
      if (!studioId) {
        renderHistory([]);
        return;
      }
      const history = await api.getPaymentHistory({ studioId });
      renderHistory(history);
    }

    async function loadAll() {
      try {
        setError("");
        setLoading(true);

        // Init selects
        fillMonthSelect($("monthFilter"));
        fillMonthSelect($("entryMonth"));
        fillYearSelect($("yearFilter"), new Date().getFullYear());
        fillYearSelect($("entryYear"), new Date().getFullYear());

        // Defaults
        const now = new Date();
        $("monthFilter").value = String(now.getMonth() + 1);
        $("yearFilter").value = String(now.getFullYear());
        syncEntryMonthYear();
        $("paymentDate").valueAsDate = new Date();

        // Load properties
        const api = getAPI();
        const props = await api.getProperties();
        State.properties = Array.isArray(props) ? props : [];
        renderPropertyFilter();

        // Load records + unpaid + history
        await refreshForPeriod();
        await refreshHistory();

        setLoading(false);
      } catch (err) {
        setLoading(false);
        setError(err?.message || "Failed to load data. Check app-config.js API_URL and Apps Script deployment.");
      }
    }

    // Entry validation
    function validateEntry() {
      const studioId = $("studioSelect").value;
      const paymentDate = $("paymentDate").value;
      const amount = Number($("amountInput").value);

      if (!studioId) return "Please select a Studio ID.";
      if (!paymentDate) return "Please select a Payment Date.";
      if (!isFinite(amount) || amount <= 0) return "Please enter a valid Amount > 0.";
      return "";
    }

    // Record payment
    async function recordPayment() {
      const api = getAPI();
      const err = validateEntry();
      if (err) { setError(err); showToast("Validation failed", err); return; }
      setError("");

      const payload = {
        studioId: $("studioSelect").value,
        month: Number($("entryMonth").value),
        year: Number($("entryYear").value),
        paymentDate: $("paymentDate").value,
        amount: Number($("amountInput").value),
        maintenance: Number($("maintenanceInput").value || 0),
        notes: ($("notesInput").value || "").trim(),
        method: "Cash", // keep as-is; you can add method select later without removing any feature
      };

      try {
        setLoading(true);
        await api.addRentPayment(payload);
        setLoading(false);

        showToast("Payment recorded", `${payload.studioId} • ${payload.month}/${payload.year}`);

        // Keep month/year synced and refresh data
        syncFilterMonthYear();
        await refreshForPeriod();
        await refreshHistory();
      } catch (e) {
        setLoading(false);
        setError(e?.message || "Failed to record payment.");
      }
    }

    async function sendReminder(studioId) {
      const api = getAPI();
      const month = Number($("entryMonth").value);
      const year = Number($("entryYear").value);

      try {
        setLoading(true);
        await api.sendReminder({ studioId, month, year });
        setLoading(false);
        showToast("Reminder triggered", `${studioId} • ${month}/${year}`);
      } catch (e) {
        setLoading(false);
        setError(e?.message || "Failed to send reminder.");
      }
    }

    async function sendBulkReminder() {
      const api = getAPI();
      const month = Number($("entryMonth").value);
      const year = Number($("entryYear").value);

      try {
        setLoading(true);
        const res = await api.sendBulkReminder({ month, year });
        setLoading(false);
        showToast("Bulk reminder triggered", res?.count ? `${res.count} recipients` : `${month}/${year}`);
      } catch (e) {
        setLoading(false);
        setError(e?.message || "Failed to send bulk reminders.");
      }
    }

    async function exportCsv() {
      const api = getAPI();
      const { month, year } = getSelectedMonthYear();

      try {
        setLoading(true);
        let csv = "";

        if (typeof api.exportCsv === "function") {
          csv = await api.exportCsv({ month, year });
        } else {
          const headers = ["tenant", "unit", "dueDate", "amount", "receivedDate", "method", "status", "notes", "studioId"];
          csv = [headers.join(",")].concat(
            (State.filtered || []).map(r =>
              headers.map(h => `"${String(r[h] ?? "").replaceAll('"', '""')}"`).join(",")
            )
          ).join("\n");
        }

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `rent-records_${year}-${pad2(month)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        setLoading(false);
        showToast("Exported CSV", `rent-records_${year}-${pad2(month)}.csv`);
      } catch (e) {
        setLoading(false);
        setError(e?.message || "Export failed.");
      }
    }

    function clearForm() {
      $("amountInput").value = "";
      $("maintenanceInput").value = "";
      $("notesInput").value = "";
      $("paymentDate").valueAsDate = new Date();
      showToast("Cleared", "Entry form reset");
    }

    function toggleEntry() {
      const body = $("entryBody");
      const btn = $("toggleEntryBtn");
      const isHidden = body.style.display === "none";
      body.style.display = isHidden ? "" : "none";
      btn.innerHTML = isHidden
        ? `<i class="fas fa-chevron-up"></i> Collapse`
        : `<i class="fas fa-chevron-down"></i> Expand`;
    }

    // Hooks (kept; no features removed)
    async function markPaidSelected() {
      // This is a hook to your backend. Keeping the button + behavior placeholder.
      // If your app-data.js supports it, you can implement PropertyPilotApi.markPaid(...)
      showToast("Mark Paid", "Hook ready (implement in app-data.js / Apps Script if needed).");
    }

    // Event wiring (kept)
    $("searchInput").addEventListener("input", () => { applyFilters(); renderTable(); });
    $("statusFilter").addEventListener("change", () => { applyFilters(); renderTable(); });
    $("propertyFilter").addEventListener("change", () => { applyFilters(); renderTable(); });

    $("monthFilter").addEventListener("change", async () => {
      syncEntryMonthYear();
      await refreshForPeriod();
      await refreshHistory();
    });
    $("yearFilter").addEventListener("change", async () => {
      syncEntryMonthYear();
      await refreshForPeriod();
      await refreshHistory();
    });

    $("entryMonth").addEventListener("change", async () => {
      syncFilterMonthYear();
      await refreshForPeriod();
      await refreshHistory();
    });
    $("entryYear").addEventListener("change", async () => {
      syncFilterMonthYear();
      await refreshForPeriod();
      await refreshHistory();
    });

    $("onlyUnpaidChk").addEventListener("change", () => renderStudioSelect());
    $("studioSelect").addEventListener("change", () => refreshHistory());

    $("recordPaymentBtn").addEventListener("click", recordPayment);
    $("emailReminderBtn").addEventListener("click", () => sendReminder($("studioSelect").value));
    $("bulkReminderBtn").addEventListener("click", sendBulkReminder);

    $("historyRefreshBtn").addEventListener("click", refreshHistory);
    $("clearFormBtn").addEventListener("click", clearForm);
    $("toggleEntryBtn").addEventListener("click", toggleEntry);

    $("syncBtn").addEventListener("click", async () => {
      try {
        setError("");
        setLoading(true);
        await refreshForPeriod();
        await refreshHistory();
        setLoading(false);
        showToast("Refreshed", "Live data updated");
      } catch (e) {
        setLoading(false);
        setError(e?.message || "Refresh failed.");
      }
    });

    $("exportBtn").addEventListener("click", exportCsv);

    $("prevBtn").addEventListener("click", () => {
      if (State.page <= 1) return;
      State.page -= 1;
      renderTable();
    });

    $("nextBtn").addEventListener("click", () => {
      const total = (State.filtered || []).length;
      const maxPage = Math.max(1, Math.ceil(total / State.pageSize));
      if (State.page >= maxPage) return;
      State.page += 1;
      renderTable();
    });

    $("rentRecordsTbody").addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;

      const tr = btn.closest("tr");
      const studioId = tr?.dataset?.studioId || "";
      const action = btn.dataset.action;

      if (action === "select") {
        if (studioId) {
          $("studioSelect").value = studioId;
          await refreshHistory();
          showToast("Selected", studioId);
          $("rentEntryCard").scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      if (action === "remind") {
        if (studioId) await sendReminder(studioId);
      }
    });

    $("openInSheetBtn").addEventListener("click", () => {
      const api = getAPI();
      const url = api.sheetUrl || (window.APP_CONFIG && window.APP_CONFIG.SHEET_URL) || "";
      if (!url) {
        showToast("Sheet link not set", "Add SHEET_URL in app-config.js");
        return;
      }
      window.open(url, "_blank", "noopener,noreferrer");
    });

    $("openEntryBtn").addEventListener("click", () => {
      $("rentEntryCard").scrollIntoView({ behavior: "smooth", block: "start" });
      const body = $("entryBody");
      if (body.style.display === "none") toggleEntry();
    });

    $("markPaidBtn").addEventListener("click", markPaidSelected);

    // Start
    window.addEventListener("DOMContentLoaded", async () => {
      // Preserve your existing system init (no deletion)
      try {
        if (window.PropertyPilot && typeof window.PropertyPilot.initPage === "function") {
          // Keep for compatibility with your existing app.js routing if any
          // Not forcing it to avoid double-loading.
        }
      } catch { /* no-op */ }

      await loadAll();
    });
  </script>
</body>
</html>
